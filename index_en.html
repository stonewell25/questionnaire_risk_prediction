<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk Prediction Evaluation Survey</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f0ebf8;
      min-height: 100vh;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .header-card {
      background: #fff;
      border-radius: 8px;
      border-top: 10px solid #673ab7;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .header-card h1 {
      font-size: 32px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 8px;
    }

    .header-card p {
      color: #5f6368;
      font-size: 14px;
    }

    .required-note {
      color: #d93025;
      font-size: 14px;
      margin-top: 16px;
    }

    /* è³ªå•ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      border-left: 4px solid transparent;
    }

    .card:focus-within {
      border-left-color: #673ab7;
    }

    .card-title {
      font-size: 16px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 16px;
    }

    .card-title .required {
      color: #d93025;
      margin-left: 4px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .section-header {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border-radius: 8px;
      padding: 20px 24px;
      margin: 24px 0 12px 0;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .section-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .image-section {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .image-section img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .image-label {
      background: #673ab7;
      color: white;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
    input[type="text"],
    input[type="email"] {
      width: 100%;
      padding: 8px 0;
      border: none;
      border-bottom: 1px solid #dadce0;
      font-size: 16px;
      font-family: inherit;
      background: transparent;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-bottom: 2px solid #673ab7;
    }

    input[type="text"]::placeholder,
    input[type="email"]::placeholder {
      color: #80868b;
    }

    /* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚«ãƒ¼ãƒ‰ */
    .agent-card {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .agent-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .agent-badge {
      background: #673ab7;
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .risk-badge {
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .risk-badge.critical {
      background: #fce8e6;
      color: #c5221f;
    }

    .risk-badge.major {
      background: #fef7e0;
      color: #e37400;
    }

    .risk-badge.minor {
      background: #e8f0fe;
      color: #1967d2;
    }

    .risk-badge.none {
      background: #e6f4ea;
      color: #137333;
    }

    .agent-reason {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #3c4043;
      margin-bottom: 20px;
      line-height: 1.7;
    }

    /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆ5æ®µéšè©•ä¾¡ï¼‰ */
    .rating-group {
      margin-bottom: 20px;
    }

    .rating-label {
      font-size: 14px;
      color: #202124;
      margin-bottom: 12px;
      display: block;
    }

    .rating-label .required {
      color: #d93025;
    }

    .rating-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rating-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .rating-option:hover {
      background: #f8f9fa;
    }

    .rating-option input[type="radio"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #5f6368;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }

    .rating-option input[type="radio"]:checked {
      border-color: #673ab7;
    }

    .rating-option input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: #673ab7;
      border-radius: 50%;
    }

    .rating-option label {
      font-size: 14px;
      color: #202124;
      cursor: pointer;
    }

    /* æœªå›ç­”ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .rating-group.error {
      background: #fce8e6;
      border-radius: 8px;
      padding: 12px;
      margin: -12px;
      margin-bottom: 8px;
      animation: shake 0.5s ease;
    }

    .rating-group.error .rating-label {
      color: #c5221f;
    }

    .error-message {
      color: #c5221f;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .rating-group.error .error-message {
      display: block;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-5px);
      }

      75% {
        transform: translateX(5px);
      }
    }

    /* ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .help-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #673ab7;
      cursor: pointer;
      margin-left: 8px;
      text-decoration: none;
      user-select: none;
    }

    .help-toggle:hover {
      text-decoration: underline;
    }

    .help-toggle::before {
      content: 'â„¹ï¸';
      font-size: 14px;
    }

    .help-content {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 3px solid #673ab7;
      border-radius: 4px;
      font-size: 12px;
      color: #5f6368;
    }

    .help-content.show {
      display: block;
    }

    .help-content ul {
      margin: 8px 0 0 16px;
      padding: 0;
    }

    .help-content li {
      margin-bottom: 4px;
    }

    /* æœªå›ç­”ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º */
    .unanswered-alert {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #c5221f;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      font-size: 14px;
      display: none;
    }

    .unanswered-alert.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f0ebf8;
      padding: 8px 0;
    }

    .progress-bar {
      height: 4px;
      background: #dadce0;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #673ab7;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 12px;
      color: #5f6368;
      margin-top: 4px;
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn-group {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #dadce0;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #673ab7;
      color: white;
    }

    .btn-primary:hover {
      background: #5e35b1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: transparent;
      color: #673ab7;
    }

    .btn-secondary:hover {
      background: #f3e5f5;
    }

    /* å®Œäº†ç”»é¢ */
    .complete-card {
      background: #fff;
      border-radius: 8px;
      border-top: 10px solid #673ab7;
      padding: 48px 24px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .complete-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .complete-card h2 {
      font-size: 24px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 8px;
    }

    .complete-card p {
      color: #5f6368;
      margin-bottom: 24px;
    }

    .download-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* éè¡¨ç¤º */
    .hidden {
      display: none !important;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 48px;
      color: #5f6368;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #dadce0;
      border-top-color: #673ab7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .lang-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 20px;
      text-decoration: none;
      color: #333;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.2s;
    }

    .lang-switch:hover {
      background: #f5f5f5;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body>
  <a href="index_ja.html" class="lang-switch">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</a>
  <div class="container">
    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div class="progress-container hidden" id="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progress-text">0 / 0</div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading data...</p>
    </div>

    <!-- Intro: Explanation Page -->
    <div id="phase-intro" class="hidden">
      <div class="header-card">
        <h1>About the Risk Prediction Evaluation Survey</h1>
        <p style="margin-top: 8px;">
          This survey asks for <strong>your subjective evaluation</strong> of<br>
          <strong>"household accident risk explanations" generated by LLM (Large Language Models)</strong>.
        </p>
      </div>

      <div class="card">
        <div class="card-title">What You Will Do</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          This survey consists of <strong>2 steps</strong>.
        </p>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px; margin-top: 12px;">
          <strong>Step 1: Risk Evaluation Assessment</strong><br>
          ãƒ»View images one by one and read "risk explanation texts" generated by <strong>multiple AI
            agents</strong>.<br>
          ãƒ»For each explanation, evaluate <strong>intuitive agreement</strong> and <strong>validity/diversity of
            rationale</strong> on a 5-point scale.
        </p>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px; margin-top: 12px;">
          <strong>Step 2: Task Planning Evaluation</strong><br>
          ãƒ»After risk evaluation, review the "countermeasures (task plans)" proposed by AI for those risks.<br>
          ãƒ»Similarly evaluate task plans for <strong>intuitive agreement</strong> and <strong>validity/diversity of
            rationale</strong> on a 5-point scale.
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-top: 8px;">
          â€» Some explanations may contain phrases like "based on feedback..." or "maintaining previous evaluation"<br>
          which are traces of agents discussing with each other,<br>
          <strong>Please ignore such history details</strong> and evaluate based on <strong>the overall impression of
            the final text</strong>.
        </p>
      </div>

      <div class="card">
        <div class="card-title">How to Evaluate (2 Evaluation Axes)</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          <strong>1. Intuitive Agreement</strong><br>
          Question: "Does the risk category (Urgent/Major to Safe) given by the system match your intuition?"
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-bottom: 8px;">
          Purpose: Measure the correctness of the final judgment.
        </p>
        <ul style="font-size: 13px; color: #5f6368; margin-left: 16px; margin-bottom: 16px;">
          <li><strong>5 - Very convincing (matches my intuition)</strong>: I would classify it in almost the same
            category</li>
          <li><strong>4 - Mostly convincing</strong>: Generally agree, but some minor concerns</li>
          <li><strong>3 - Neutral</strong>: Hard to say if it's good or bad</li>
          <li><strong>2 - Somewhat unconvincing</strong>: Slightly different from my intuition</li>
          <li><strong>1 - Not convincing at all</strong>: Completely different from my intuition / Risk perception is
            off</li>
        </ul>

        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          <strong>2. Validity & Diversity of Rationale</strong><br>
          Question: "Is the reasoning content appropriate and sufficient?"
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-bottom: 8px;">
          Purpose: Measure the quality of the reasoning process. Evaluates "overthinking" and "insufficient rationale"
          on the same scale.
        </p>
        <ul style="font-size: 13px; color: #5f6368; margin-left: 16px;">
          <li><strong>5 - Overly reactive</strong>: Worrying too much about very low probability scenarios</li>
          <li><strong>4 - Somewhat overthinking</strong>: Logic is sound, but includes unnecessary concerns</li>
          <li><strong>3 - Appropriate and multifaceted</strong>: Various information is balanced well</li>
          <li><strong>2 - Insufficient rationale</strong>: Intuitive, but lacks explanation of why</li>
          <li><strong>1 - Inappropriate/irrelevant rationale</strong>: Mentions completely unrelated things</li>
        </ul>
        <p style="font-size: 13px; color: #5f6368; margin-top: 8px;">
          â€» A longer text doesn't mean "well thought out".<br>
          <strong>Focus on whether the conclusion and reasoning match your intuition, and whether the rationale is
            appropriate</strong>.
        </p>
      </div>

      <div class="card">
        <div class="card-title">Time Required & Notes</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          ãƒ»Due to the number of images and agents, this will take <strong>approximately 30-60 minutes</strong>.<br>
          ãƒ»If you feel tired, please <strong>take breaks as needed</strong>.<br>
          ãƒ»You don't have to answer every question perfectly, but <strong>we greatly appreciate your careful
            evaluation</strong>.
        </p>
      </div>

      <div class="card">
        <div class="card-title">Fun Element: Fortune Draw & Prizes</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          After completing all image evaluations, you can <strong>draw a "fortune"</strong> at the end.
        </p>
        <p style="font-size: 13px; color: #5f6368;">
          Based on your fortune result, we plan to give you <strong>a small prize</strong> (snacks, souvenirs, etc.)
          after the New Year.<br>
          Results will be confirmed along with the survey aggregation, so look forward to it!
        </p>
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <div></div>
        <button class="btn btn-primary" onclick="goToAgentExplanation()">I've read the explanation, Next</button>
      </div>
    </div>

    <div id="phase-agent-explanation" class="hidden">
      <div class="header-card">
        <h1>What are AI Agents?</h1>
        <p>Let us explain the "evaluators" that appear in this survey.</p>
      </div>

      <div class="card">
        <div class="card-title">ğŸ¤– Difference between "AI" and "AI Agents"</div>
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 16px;">
          <div style="font-size: 40px;">ğŸ’¬</div>
          <div>
            <strong>Regular Chat AI</strong><br>
            <span style="font-size: 13px; color: #5f6368;">Just answers what is asked. No particular personality or
              position.</span>
          </div>
        </div>
        <div style="text-align: center; font-size: 20px; color: #dadce0; margin: 8px 0;">â¬‡ï¸ Evolution â¬‡ï¸</div>
        <div style="display: flex; gap: 20px; align-items: center; margin-top: 16px;">
          <div style="font-size: 40px;">ğŸ•µï¸</div>
          <div>
            <strong>AI Agent (Today's Evaluators)</strong><br>
            <span style="font-size: 13px; color: #5f6368;">Has <strong>"personality", "role", "expertise"</strong>.<br>
              Thinks about risk from perspectives like "What if I were a worried parent?" or "What if I were a strict
              safety officer?"</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Why Compare Multiple Agents?</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 12px;">
          Risk perception varies from person to person.<br>
          For example, for the situation <strong>"a knife is placed on the counter"</strong>:
        </p>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 12px;">
              <span class="agent-badge">Agent A (Normal)</span> <span style="font-size: 14px;">"It's normal during
                cooking. No risk."</span>
            </li>
            <li style="margin-bottom: 12px;">
              <span class="agent-badge" style="background: #e37400;">Agent H (Strict)</span> <span
                style="font-size: 14px;">"Could fall during earthquake and stab foot. <strong>Potential
                  risk!</strong>"</span>
            </li>
            <li>
              <span class="agent-badge" style="background: #c5221f;">Agent C (Worried)</span> <span
                style="font-size: 14px;">"A child might reach for it! <strong>Urgent risk!</strong>"</span>
            </li>
          </ul>
        </div>
        <p style="font-size: 14px; color: #5f6368;">
          As you can see, <strong>risk judgment varies by AI personality (algorithm)</strong>.<br>
          Please tell us which AI's judgment is closest to "human (your) intuition" or "most useful".
        </p>
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <button class="btn btn-secondary" onclick="backToIntro()">Back</button>
        <button class="btn btn-primary" onclick="goToNamePhase()">I Understand</button>
      </div>
    </div>

    <!-- Phase 0: Participant Information -->
    <div id="phase-name" class="hidden">
      <div class="header-card">
        <h1>Risk Prediction Evaluation Survey</h1>
        <p>Please help us evaluate the household accident risk prediction system.<br>
          This survey asks you to evaluate in <strong>2 steps</strong>.</p>
        <p style="margin-top: 8px;">
          <strong>Step 1:</strong>
          For each image, read risk evaluations by multiple AI agents and rate <strong>intuitive agreement</strong> and
          <strong>validity/diversity of rationale</strong> on a 5-point scale.<br>
          <strong>Step 2:</strong>
          After risk evaluation, evaluate the countermeasures (task plans) proposed by AI for <strong>validity</strong>
          and <strong>feasibility</strong> on a 5-point scale.
        </p>
        <p class="required-note">* indicates required fields</p>
      </div>

      <div class="card">
        <div class="card-title">Your Name<span class="required">*</span></div>
        <input type="text" id="participant-name" placeholder="Enter your name" required>
      </div>

      <div class="card">
        <div class="card-title">Email Address</div>
        <input type="email" id="participant-email" placeholder="Enter email (optional)">
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <div></div>
        <button class="btn btn-primary" onclick="startSurvey()">Next</button>
      </div>
    </div>

    <!-- Phase 1: Validityè©•ä¾¡ -->
    <div id="phase-validity" class="hidden">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- Phase 2: ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ -->
    <div id="phase-task-planning" class="hidden">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- Phase 3: Complete -->
    <div id="phase-complete" class="hidden">
      <div class="complete-card">
        <div class="complete-icon">âœ…</div>
        <h2>Response Submitted</h2>
        <p>Thank you for your cooperation!</p>
        <div class="download-buttons" style="margin-bottom: 24px;">

          <p id="warning-text" style="color: #d93025; font-weight: bold; margin-bottom: 12px;">
            Please click Submit to finish. Do not close this screen until submission is complete.
          </p>
          <button class="btn btn-primary" id="btn-send-spreadsheet" onclick="sendToSpreadsheet()"
            style="background-color: #34a853; color: white;">
            ğŸ“Š Send to Google Spreadsheet
          </button>
        </div>
        <div id="spreadsheet-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>

        <div style="margin-top: 8px; margin-bottom: 24px;">
          <p style="color: #5f6368; margin-bottom: 8px;">
            As a thank you for completing this survey, we've prepared a <strong>"fortune draw" for snacks</strong>. The
            snack you draw will be given to you, so please tell us what you got!
          </p>
          <button class="btn btn-primary" onclick="drawOmikuji()">Draw Fortune</button>
          <p id="omikuji-result" style="margin-top: 16px; font-size: 16px; color: #202124;"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // è¨­å®š
    // ============================================

    // ============================================
    // è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰
    // ============================================
    const CONFIG = {
      // è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰: 'ablation' | 'random' | 'all'
      // 'ablation': ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ï¼ˆ4-5ç¨®é¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã€æ¨å¥¨ï¼‰
      //              â†’ å›ç­”æ™‚é–“ãŒ1/3ã«çŸ­ç¸®ã€ç ”ç©¶ã®æ ¸å¿ƒã«é›†ä¸­
      // 'random': ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ1ç”»åƒã«ã¤ã3-4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
      //           â†’ å›ç­”è€…ã”ã¨ã«ç•°ãªã‚‹çµ„ã¿åˆã‚ã›ã€å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®çµ±è¨ˆå–å¾—å¯èƒ½
      // 'all': å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¡¨ç¤ºï¼ˆ14ç¨®é¡ã™ã¹ã¦ï¼‰
      //        â†’ å°‘æ•°ã®å°‚é–€å®¶å‘ã‘ã€å›ç­”è² æ‹…ãŒå¤§ãã„
      EVALUATION_MODE: 'all',

      // ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ç”¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆç ”ç©¶ã®æ ¸å¿ƒï¼‰
      ABLATION_AGENTS: [
        'Semantic_state',                    // Agent A: åŸºæº–ç‚¹ï¼ˆLLMã®ã¿ï¼‰
        'Semantic_state_RiskScore',          // Agent B: ææ¡ˆæ‰‹æ³•ï¼ˆçµ±åˆå‹ï¼‰
        'Semantic_state_RiskScore_Persona_01', // Agent C: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã®æœ‰åŠ¹æ€§
        'Semantic_state_Stickler',           // Agent H: æ¯”è¼ƒå¯¾è±¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        'VLM'                                 // Agent N: æ—¢å­˜æ‰‹æ³•ã¨ã®æ¯”è¼ƒ
      ],

      // ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ™‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°
      RANDOM_AGENT_COUNT: 4,

      // ç†Ÿæ…®åº¦ã‚’ç°¡ç•¥åŒ–ã™ã‚‹ã‹ï¼ˆtrue: åŒæ„åº¦ã®ã¿ã€false: ä¸¡æ–¹è©•ä¾¡ï¼‰
      // ç†Ÿå£«è«–æ–‡ã§ã¯ã€ŒåŒæ„åº¦ï¼‹ç†Ÿæ…®åº¦ã€ã®2è»¸ã§è©•ä¾¡ã™ã‚‹ãŸã‚ false ã«è¨­å®š
      SIMPLIFY_THOUGHT: false,

      // ç”»åƒã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘è¨­å®š
      ENABLE_GROUPING: true,  // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‹
      GROUP_SIZE: 3,          // ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®ç”»åƒæ•°

      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
      JSON_FILES: [
        './evaluation_dataset_Kitchen_en.json',
        './evaluation_dataset_LivingLab_en.json'
      ],
      // ã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
      TASK_PLANNING_FILES: [
        './evaluation_dataset_task_Kitchen_en.json',
        './evaluation_dataset_task_LivingLab_en.json'
      ],
      // ç”»åƒã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®šã€ã¾ãŸã¯çµ¶å¯¾ãƒ‘ã‚¹ï¼‰
      IMAGE_BASE_PATHS: {
        'Kitchen': './Kitchen/002_Observations/',
        'LivingLab': './Livinglab/002_Observations/'
      },

      // ç‰¹å®šã®IDã§é™¤å¤–ã™ã‚‹ç”»åƒãƒ‘ã‚¹
      EXCLUDED_IMAGE_PATHS: {
        '0': [
          'obs_20251227_042752_34a215e3/rgb.jpg',
          'obs_20251227_042806_b696a377/rgb.jpg'
        ],
        '2': [
          'obs_20251227_042752_34a215e3/rgb.jpg',
          'obs_20251227_043054_8ce47229/rgb.jpg',
          'obs_20251227_042806_b696a377/rgb.jpg'
        ],
        '3': [
          'obs_20251227_043054_8ce47229/rgb.jpg'
        ],
        '4': [
          'obs_20251227_042752_34a215e3/rgb.jpg'
        ],
        '5': [
          'obs_20251227_042926_368f4aab/rgb.jpg',
          'obs_20251227_043013_0201ff2a/rgb.jpg'
        ],
        '6': [
          'obs_20251227_042001_765b0f6a/rgb.jpg'
        ],
        '7': [
          'obs_20251227_042651_90f7ed19/rgb.jpg'
        ]
      },

      // Google Spreadsheeté€£æºè¨­å®š
      // Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„
      // è¨­å®šæ–¹æ³•: google_apps_script.gs ã‚’å‚ç…§
      SPREADSHEET_ENDPOINT: 'https://script.google.com/macros/s/AKfycbzKozJOUMPrLPWCibr0gn9jFhjyo7IXSwLggsn_XISviD_q1z_Fdk8udyjZKehLednV0w/exec'  // ä¾‹: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'
    };

    // å¯¾è±¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ¼ï¼ˆã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
    const AGENT_KEYS = [
      'Semantic_state',
      'Semantic_state_RiskScore',
      'Semantic_state_RiskScore_Persona_01',
      'Semantic_state_RiskScore_Persona_02',
      'Semantic_state_RiskScore_Persona_03',
      'Semantic_state_RiskScore_Persona_04',
      'Semantic_state_RiskScore_Persona_05',
      'Semantic_state_Stickler',
      'Semantic_state_Persona_01',
      'Semantic_state_Persona_02',
      'Semantic_state_Persona_03',
      'Semantic_state_Persona_04',
      'Semantic_state_Persona_05',
      'VLM'
    ];

    // åŒ¿ååŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå
    const AGENT_DISPLAY_NAMES = {
      'Semantic_state': 'Agent A',
      'Semantic_state_RiskScore': 'Agent B',
      'Semantic_state_RiskScore_Persona_01': 'Agent C',
      'Semantic_state_RiskScore_Persona_02': 'Agent D',
      'Semantic_state_RiskScore_Persona_03': 'Agent E',
      'Semantic_state_RiskScore_Persona_04': 'Agent F',
      'Semantic_state_RiskScore_Persona_05': 'Agent G',
      'Semantic_state_Stickler': 'Agent H',
      'Semantic_state_Persona_01': 'Agent I',
      'Semantic_state_Persona_02': 'Agent J',
      'Semantic_state_Persona_03': 'Agent K',
      'Semantic_state_Persona_04': 'Agent L',
      'Semantic_state_Persona_05': 'Agent M',
      'VLM': 'Agent N'
    };

    // 5-point rating choices
    // 1. Intuitive Agreement
    const AGREE_CHOICES = [
      { value: 5, label: 'Very convincing (matches my intuition)' },
      { value: 4, label: 'Mostly convincing' },
      { value: 3, label: 'Neutral' },
      { value: 2, label: 'Somewhat unconvincing' },
      { value: 1, label: 'Not convincing at all' }
    ];

    // 2. Validity & Diversity of Rationale
    const THOUGHT_CHOICES = [
      { value: 5, label: 'Overly reactive (worrying too much about low probability risks)' },
      { value: 4, label: 'Somewhat overthinking (logic is sound but includes unnecessary concerns)' },
      { value: 3, label: 'Appropriate and multifaceted (various information balanced well)' },
      { value: 2, label: 'Insufficient rationale (intuitive but lacks explanation)' },
      { value: 1, label: 'Inappropriate/irrelevant rationale (mentions unrelated things)' }
    ];

    // Fortune draw results
    const OMIKUJI_RESULTS = [
      { title: 'Lucky!', message: 'Oreo' },
      { title: 'Big Win!', message: 'Choco Pie (3 pieces)' },
      { title: 'Nice!', message: 'Hi-Chew' }
    ];

    // ============================================
    // ãƒ‡ãƒ¼ã‚¿
    // ============================================

    let riskData = null;
    let surveyData = {
      participant: { name: '', email: '', startTime: null, endTime: null },
      assignedGroup: null,  // å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ï¼ˆ0å§‹ã¾ã‚Šï¼‰
      validityResults: [],
      taskPlanningResults: []  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡çµæœ
    };
    let currentImageIndex = 0;
    let currentTaskPlanningIndex = 0;  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã®ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let taskPlanningImageIds = [];  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡å¯¾è±¡ã®ç”»åƒIDãƒªã‚¹ãƒˆ
    let imageIds = [];  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ç”»åƒIDãƒªã‚¹ãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å¾Œï¼‰
    let allImageIds = [];  // å…¨ç”»åƒIDãƒªã‚¹ãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å‰ï¼‰
    let imagePaths = {};  // å„ç•ªå·ã«å¯¾ã™ã‚‹ç”»åƒãƒ‘ã‚¹ç¾¤ { "0": ["path1", "path2", ...], ... }
    let imageBasePaths = {};  // å„ç•ªå·ã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ { "0": "Kitchen" or "LivingLab", ... }
    let taskPlanningData = {};  // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ { "Kitchen": { "0": {...}, ... }, "LivingLab": { "0": {...}, ... } }
    let skipValidationClickCount = 0;  // ã‚¯ãƒªãƒƒã‚¯å›æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆéš ã—ã‚³ãƒãƒ³ãƒ‰ç”¨ï¼‰
    let skipValidationEnabled = false;  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ï¼ˆéš ã—ã‚³ãƒãƒ³ãƒ‰ç”¨ï¼‰

    // ============================================
    // åˆæœŸåŒ–
    // ============================================

    async function init() {
      try {
        // 2ã¤ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§èª­ã¿è¾¼ã‚€
        const [kitchenResponse, livinglabResponse, kitchenTaskResponse, livinglabTaskResponse] = await Promise.all([
          fetch(CONFIG.JSON_FILES[0]),
          fetch(CONFIG.JSON_FILES[1]),
          fetch(CONFIG.TASK_PLANNING_FILES[0]).catch(() => ({ ok: false })),
          fetch(CONFIG.TASK_PLANNING_FILES[1]).catch(() => ({ ok: false }))
        ]);

        if (!kitchenResponse.ok || !livinglabResponse.ok) {
          throw new Error(`HTTP error! Kitchen: ${kitchenResponse.status}, LivingLab: ${livinglabResponse.status}`);
        }

        const kitchenData = await kitchenResponse.json();
        const livinglabData = await livinglabResponse.json();

        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        taskPlanningData = {
          'Kitchen': {},
          'LivingLab': {}
        };

        // â˜…ä¿®æ­£: è¾æ›¸å½¢å¼ã®JSONã«å¯¾å¿œ
        if (kitchenTaskResponse.ok) {
          try {
            const kitchenTaskData = await kitchenTaskResponse.json();
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹ï¼ˆå¿µã®ãŸã‚ä¸¡å¯¾å¿œï¼‰
            if (kitchenTaskData.task_planning && Array.isArray(kitchenTaskData.task_planning)) {
              // é…åˆ—å½¢å¼ã®å ´åˆ
              kitchenTaskData.task_planning.forEach(task => {
                const predictionId = task.risk_prediction_id.toString();
                taskPlanningData['Kitchen'][predictionId] = task;
              });
            } else {
              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®å ´åˆï¼ˆä»Šå›ã®ã‚±ãƒ¼ã‚¹ï¼‰
              for (const [key, value] of Object.entries(kitchenTaskData)) {
                // keyã¯ "0", "1" ãªã©ã®ID
                taskPlanningData['Kitchen'][key] = value;
              }
            }
          } catch (e) {
            console.warn('Kitchenã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
          }
        }

        if (livinglabTaskResponse.ok) {
          try {
            const livinglabTaskData = await livinglabTaskResponse.json();
            // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹
            if (livinglabTaskData.task_planning && Array.isArray(livinglabTaskData.task_planning)) {
              livinglabTaskData.task_planning.forEach(task => {
                const predictionId = task.risk_prediction_id.toString();
                taskPlanningData['LivingLab'][predictionId] = task;
              });
            } else {
              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®å ´åˆï¼ˆä»Šå›ã®ã‚±ãƒ¼ã‚¹ï¼‰
              for (const [key, value] of Object.entries(livinglabTaskData)) {
                taskPlanningData['LivingLab'][key] = value;
              }
            }
          } catch (e) {
            console.warn('LivingLabã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
          }
        }

        console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿:', taskPlanningData);

        // ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆï¼ˆãƒªã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã¯ãã®ã¾ã¾ï¼‰
        riskData = {};
        imagePaths = {};
        imageBasePaths = {};

        // Kitchenãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
        for (const [key, value] of Object.entries(kitchenData)) {
          riskData[key] = value;
          imageBasePaths[key] = 'Kitchen';
          if (value.observations && Array.isArray(value.observations)) {
            const excludedPaths = CONFIG.EXCLUDED_IMAGE_PATHS[key] || [];
            imagePaths[key] = value.observations
              .map(obs => obs.rgb_path)
              .filter(path => path && !excludedPaths.includes(path));
          } else {
            imagePaths[key] = [];
          }
        }

        // LivingLabãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
        const maxKitchenKey = Math.max(...Object.keys(kitchenData).map(k => parseInt(k) || 0));
        for (const [key, value] of Object.entries(livinglabData)) {
          const newKey = (parseInt(key) + maxKitchenKey + 1).toString();
          riskData[newKey] = value;
          imageBasePaths[newKey] = 'LivingLab';
          if (value.observations && Array.isArray(value.observations)) {
            const excludedPaths = CONFIG.EXCLUDED_IMAGE_PATHS[key] || [];
            imagePaths[newKey] = value.observations
              .map(obs => obs.rgb_path)
              .filter(path => path && !excludedPaths.includes(path));
          } else {
            imagePaths[newKey] = [];
          }
        }

        allImageIds = Object.keys(riskData).sort((a, b) => parseInt(a) - parseInt(b));
        imageIds = allImageIds;

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('phase-intro').classList.remove('hidden');

        if (CONFIG.ENABLE_GROUPING && allImageIds.length > 0) {
          const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
          const groupingInfoCard = document.getElementById('grouping-info-card');
          const groupingInfoText = document.getElementById('grouping-info-text');
          if (groupingInfoCard && groupingInfoText) {
            groupingInfoCard.style.display = 'block';
            groupingInfoText.innerHTML = `
              ãƒ»All ${allImageIds.length} images are divided into ${totalGroups} groups of ${CONFIG.GROUP_SIZE} images each.<br>
              ãƒ»When you enter your name, you will be automatically assigned to one of the groups.<br>
              ãƒ»You will only evaluate <strong>one group (${CONFIG.GROUP_SIZE} images)</strong>.<br>
              ãƒ»This reduces the evaluation burden per person.
            `;
          }
        }
      } catch (error) {
        console.error('Data loading error:', error);
        document.getElementById('loading').innerHTML = `
          <p style="color: #d93025;">Error: Could not load data</p>
          <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
        `;
      }
    }

    // ============================================
    // èª¿æŸ»é–‹å§‹
    // ============================================

    // èª¬æ˜ãƒšãƒ¼ã‚¸ã¸é€²ã‚€ï¼ˆIntroç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    function goToAgentExplanation() {
      document.getElementById('phase-intro').classList.add('hidden');
      document.getElementById('phase-agent-explanation').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // èª¬æ˜ãƒšãƒ¼ã‚¸ã‹ã‚‰Introã¸æˆ»ã‚‹
    function backToIntro() {
      document.getElementById('phase-agent-explanation').classList.add('hidden');
      document.getElementById('phase-intro').classList.remove('hidden');
    }

    // åå‰å…¥åŠ›ç”»é¢ã¸é€²ã‚€ï¼ˆAgentExplanationç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    // â€»æ—¢å­˜ã®é–¢æ•°ã‚’æ›¸ãæ›ãˆã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã® goToNamePhase ã¯ãã®ã¾ã¾åˆ©ç”¨ã—ã¾ã™ã€‚
    //   ãŸã ã—ã€phase-intro ã‚’éš ã™å‡¦ç†ã ã‘ã§ãªã phase-agent-explanation ã‚’éš ã™å‡¦ç†ã‚‚å¿…è¦ã«ãªã‚Šã¾ã™ã€‚

    /* æ—¢å­˜ã® goToNamePhase é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ 
       ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼‰
    */
    function goToNamePhase() {
      // 1. æœ€åˆã®èª¬æ˜ç”»é¢ã‚’éš ã™
      document.getElementById('phase-intro').classList.add('hidden');

      // 2. ã€ã“ã“ãŒé‡è¦ã€‘ã€ŒAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ï¼Ÿã€ç”»é¢ã‚‚éš ã™
      const agentExpl = document.getElementById('phase-agent-explanation');
      if (agentExpl) {
        agentExpl.classList.add('hidden');
      }

      // 3. åå‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
      document.getElementById('phase-name').classList.remove('hidden');

      // 4. ç”»é¢ã®ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo(0, 0);
    }

    // function goToNamePhase() {
    //   document.getElementById('phase-intro').classList.add('hidden');
    //   document.getElementById('phase-name').classList.remove('hidden');
    // }

    function startSurvey() {
      const name = document.getElementById('participant-name').value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }

      surveyData.participant.name = name;
      surveyData.participant.email = document.getElementById('participant-email').value.trim();
      surveyData.participant.startTime = new Date().toISOString();

      // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã®å‡¦ç†
      if (CONFIG.ENABLE_GROUPING && allImageIds.length > 0) {
        const groups = createImageGroups(allImageIds, CONFIG.GROUP_SIZE);
        const groupNumber = assignGroupToParticipant(name, groups.length);
        surveyData.assignedGroup = groupNumber;
        imageIds = groups[groupNumber] || [];
        console.log(`ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘: å…¨${allImageIds.length}æšã‚’${groups.length}ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã€ã‚°ãƒ«ãƒ¼ãƒ—${groupNumber + 1}ï¼ˆ${imageIds.length}æšï¼‰ã‚’å‰²ã‚Šå½“ã¦`);
      } else {
        // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãŒç„¡åŠ¹ã€ã¾ãŸã¯ç”»åƒãŒãªã„å ´åˆã¯å…¨ç”»åƒã‚’ä½¿ç”¨
        imageIds = allImageIds;
        surveyData.assignedGroup = null;
      }

      document.getElementById('phase-name').classList.add('hidden');
      document.getElementById('progress-container').classList.remove('hidden');
      document.getElementById('phase-validity').classList.remove('hidden');

      loadCurrentImage();
    }

    // ============================================
    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠãƒ­ã‚¸ãƒƒã‚¯
    // ============================================

    /**
     * è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹
     */
    function getAgentsToDisplay(imageId) {
      const imageData = riskData[imageId];

      // åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const availableAgents = AGENT_KEYS.filter(key => {
        const agentData = imageData[key];
        if (!agentData) return false;
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        return !!reason;
      });

      switch (CONFIG.EVALUATION_MODE) {
        case 'ablation':
          // ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ï¼šæŒ‡å®šã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿
          return availableAgents.filter(key => CONFIG.ABLATION_AGENTS.includes(key));

        case 'random':
          // ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼šå‚åŠ è€…IDãƒ™ãƒ¼ã‚¹ã§ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆå†ç¾å¯èƒ½ï¼‰
          const participantId = surveyData.participant.name || 'default';
          const seed = hashString(participantId + imageId);
          const shuffled = shuffleArray([...availableAgents], seed);
          return shuffled.slice(0, CONFIG.RANDOM_AGENT_COUNT);

        case 'all':
        default:
          // å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¡¨ç¤º
          return availableAgents;
      }
    }

    /**
     * æ–‡å­—åˆ—ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆåŒã˜å‚åŠ è€…ãƒ»åŒã˜ç”»åƒã§åŒã˜çµæœã‚’è¿”ã™ï¼‰
     */
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash);
    }

    /**
     * ã‚·ãƒ¼ãƒ‰ä»˜ãã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆå†ç¾å¯èƒ½ãªãƒ©ãƒ³ãƒ€ãƒ ï¼‰
     */
    function shuffleArray(array, seed) {
      const shuffled = [...array];
      let random = seed;
      for (let i = shuffled.length - 1; i > 0; i--) {
        random = (random * 9301 + 49297) % 233280;
        const j = Math.floor((random / 233280) * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // ============================================
    // ç”»åƒã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
    // ============================================

    /**
     * ç”»åƒIDã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã™ã‚‹
     * @param {string[]} imageIds - ç”»åƒIDã®é…åˆ—
     * @param {number} groupSize - ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®ç”»åƒæ•°
     * @returns {string[][]} ã‚°ãƒ«ãƒ¼ãƒ—ã®é…åˆ—
     */
    function createImageGroups(imageIds, groupSize) {
      if (groupSize <= 0 || groupSize >= imageIds.length) {
        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚ºãŒç„¡åŠ¹ã€ã¾ãŸã¯ç”»åƒæ•°ä»¥ä¸‹ã®å ´åˆã¯ã€å…¨ç”»åƒã‚’1ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«
        return [imageIds];
      }

      const groups = [];
      for (let i = 0; i < imageIds.length; i += groupSize) {
        groups.push(imageIds.slice(i, i + groupSize));
      }
      return groups;
    }

    /**
     * å‚åŠ è€…ã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆé †ç•ªæ–¹å¼ï¼‰
     * @param {string} participantName - å‚åŠ è€…å
     * @param {number} totalGroups - ã‚°ãƒ«ãƒ¼ãƒ—ç·æ•°
     * @returns {number} å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ï¼ˆ0å§‹ã¾ã‚Šï¼‰
     */
    function assignGroupToParticipant(participantName, totalGroups) {
      if (totalGroups <= 0) return 0;
      // åå‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ã‚’æ±ºå®šï¼ˆé †ç•ªæ–¹å¼ï¼‰
      const hash = hashString(participantName);
      return hash % totalGroups;
    }

    // ============================================
    // ç”»åƒèª­ã¿è¾¼ã¿
    // ============================================

    function loadCurrentImage() {
      if (currentImageIndex >= imageIds.length) {
        // ãƒªã‚¹ã‚¯è©•ä¾¡ãŒå®Œäº†ã—ãŸã‚‰ã€ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã‚€
        console.log(`ãƒªã‚¹ã‚¯è©•ä¾¡å®Œäº†: ${currentImageIndex} / ${imageIds.length} æšè©•ä¾¡æ¸ˆã¿`);
        startTaskPlanningPhase();
        return;
      }

      const imageId = imageIds[currentImageIndex];
      const imageData = riskData[imageId];
      const container = document.getElementById('phase-validity');

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = ((currentImageIndex) / imageIds.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      let progressText = `${currentImageIndex + 1} / ${imageIds.length}`;
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        progressText = `Group ${surveyData.assignedGroup + 1}: ${progressText}`;
      }
      document.getElementById('progress-text').textContent = progressText;

      // è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
      const agentsToDisplay = getAgentsToDisplay(imageId);

      // Mode info display
      let modeInfo = '';
      if (CONFIG.EVALUATION_MODE === 'ablation') {
        modeInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Ablation evaluation mode: Showing ${agentsToDisplay.length} agents</p>`;
      } else if (CONFIG.EVALUATION_MODE === 'random') {
        modeInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Random sampling mode: Showing ${agentsToDisplay.length} agents</p>`;
      }

      // Group info display
      let groupInfo = '';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        groupInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Group ${surveyData.assignedGroup + 1}/${totalGroups} (Evaluating ${imageIds.length} of ${allImageIds.length} images)</p>`;
      }

      // ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆæœ€åˆã®ç”»åƒãƒ‘ã‚¹ã‚’ä½¿ç”¨ï¼‰
      const paths = imagePaths[imageId] || [];
      const basePath = imageBasePaths[imageId] || 'Kitchen';
      const firstImagePath = paths.length > 0 ? paths[0] : null;
      const imageSrc = firstImagePath
        ? `${CONFIG.IMAGE_BASE_PATHS[basePath]}${firstImagePath}`
        : `https://via.placeholder.com/600x400?text=Image+${imageId}`;
      const imageLabel = `${basePath} - Image ${imageId}${paths.length > 1 ? ` (Showing 1 of ${paths.length} images)` : ''}`;

      // HTMLã‚’ç”Ÿæˆ
      let html = `
        <div class="section-header">
          <h2>Evaluation for Image ${imageId}</h2>
          <p>${currentImageIndex + 1} / ${imageIds.length}</p>
          ${groupInfo}
          ${modeInfo}
        </div>

        <div class="image-section">
          <img src="${imageSrc}" alt="Image ${imageId}" onerror="this.src='https://via.placeholder.com/600x400?text=Image+${imageId}'">
        </div>
      `;

      // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã®è©•ä¾¡ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        // ãƒªã‚¹ã‚¯ç†ç”±ã‚’å–å¾—ï¼ˆupdated_reason_01ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆï¼‰
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        const judge = agentData.updated_judge_01 || agentData.risk_judge;

        if (!reason) continue;

        const displayName = AGENT_DISPLAY_NAMES[agentKey] || agentKey;
        const badgeClass = getBadgeClass(judge);

        html += `
          <div class="agent-card">
            <div class="agent-header">
              <span class="agent-badge">${displayName}</span>
              <span class="risk-badge ${badgeClass}">${getRiskLabel(judge)}</span>
            </div>
            <div class="agent-reason">${reason}</div>
            
            <div class="rating-group" id="agree-group-${imageId}-${agentKey}">
              <div class="rating-label">
                1. Intuitive Agreement<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('agree-help-${imageId}-${agentKey}')">See evaluation criteria</span>
              </div>
              <div class="help-content" id="agree-help-${imageId}-${agentKey}">
                <strong>Question:</strong> Does the risk category (Urgent/Major to Safe) given by the system match your intuition?<br>
                <strong>Purpose:</strong> Measure the correctness of the final judgment.<br><br>
                <strong>Evaluation Criteria:</strong>
                <ul>
                  <li><strong>5 - Very convincing (matches my intuition)</strong>: I would classify it in almost the same category</li>
                  <li><strong>4 - Mostly convincing</strong>: Generally agree, but some minor concerns</li>
                  <li><strong>3 - Neutral</strong>: Hard to say if it's good or bad</li>
                  <li><strong>2 - Somewhat unconvincing</strong>: Slightly different from my intuition</li>
                  <li><strong>1 - Not convincing at all</strong>: Completely different from my intuition / Risk perception is off</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">Does the risk category match your intuition?</p>
              <div class="rating-options">
                ${AGREE_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="agree-${imageId}-${agentKey}" id="agree-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="agree-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">Please answer this question</div>
            </div>

            ${CONFIG.SIMPLIFY_THOUGHT ? '' : `
            <div class="rating-group" id="thought-group-${imageId}-${agentKey}">
              <div class="rating-label">
                2. Validity & Diversity of Rationale<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('thought-help-${imageId}-${agentKey}')">See evaluation criteria</span>
              </div>
              <div class="help-content" id="thought-help-${imageId}-${agentKey}">
                <strong>Question:</strong> Is the reasoning content appropriate and sufficient?<br>
                <strong>Purpose:</strong> Measure the quality of the reasoning process. Evaluates "overthinking" and "insufficient rationale" on the same scale.<br><br>
                <strong>Evaluation Criteria:</strong>
                <ul>
                  <li><strong>5 - Overly reactive</strong>: Worrying too much about very low probability scenarios</li>
                  <li><strong>4 - Somewhat overthinking</strong>: Logic is sound, but includes unnecessary concerns</li>
                  <li><strong>3 - Appropriate and multifaceted</strong>: Various information is balanced well</li>
                  <li><strong>2 - Insufficient rationale</strong>: Intuitive, but lacks explanation of why</li>
                  <li><strong>1 - Inappropriate/irrelevant rationale</strong>: Mentions completely unrelated things</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">Is the reasoning content appropriate?</p>
              <div class="rating-options">
                ${THOUGHT_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="thought-${imageId}-${agentKey}" id="thought-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="thought-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">Please answer this question</div>
            </div>
            `}
          </div>
        `;
      }

      html += `
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevImage()" ${currentImageIndex === 0 ? 'disabled style="opacity:0.5"' : ''}>Back</button>
          <button class="btn btn-primary" onclick="nextImage()">
            ${currentImageIndex === imageIds.length - 1 ? 'Submit' : 'Next'}
          </button>
        </div>
      `;

      container.innerHTML = html;
      window.scrollTo(0, 0);

      // ã‚¯ãƒªãƒƒã‚¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      skipValidationClickCount = 0;
      skipValidationEnabled = false;

      // éš ã—ã‚³ãƒãƒ³ãƒ‰: ãƒšãƒ¼ã‚¸ã®ç©ºã„ã¦ã„ã‚‹å ´æ‰€ã‚’5å›ä»¥ä¸Šã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—
      const containerElement = document.getElementById('phase-validity');
      if (containerElement) {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const newContainerElement = containerElement.cloneNode(true);
        containerElement.parentNode.replaceChild(newContainerElement, containerElement);

        newContainerElement.addEventListener('click', function (e) {
          // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ï¼ˆinput, button, labelãªã©ï¼‰ä»¥å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
          const isFormElement = e.target.tagName === 'INPUT' ||
            e.target.tagName === 'BUTTON' ||
            e.target.tagName === 'LABEL' ||
            e.target.closest('.rating-option') ||
            e.target.closest('.btn') ||
            e.target.closest('.help-toggle') ||
            e.target.closest('.help-content');

          if (!isFormElement) {
            skipValidationClickCount++;
            if (skipValidationClickCount >= 5 && !skipValidationEnabled) {
              skipValidationEnabled = true;
              console.log('éš ã—ã‚³ãƒãƒ³ãƒ‰æœ‰åŠ¹åŒ–: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€²ã‚ã¾ã™');
              // è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
              newContainerElement.style.border = '3px solid #673ab7';
              newContainerElement.style.transition = 'border 0.3s';
              setTimeout(() => {
                newContainerElement.style.border = '';
              }, 1000);
            }
          }
        });
      }
    }

    // ============================================
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    // ============================================

    function nextImage() {
      // éš ã—ã‚³ãƒãƒ³ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (skipValidationEnabled) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¿å­˜
        saveCurrentResponses(false);
      } else {
        // é€šå¸¸é€šã‚Šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ã‚Šã§ä¿å­˜
        if (!saveCurrentResponses()) {
          return;
        }
      }

      currentImageIndex++;
      loadCurrentImage();
    }

    function prevImage() {
      if (currentImageIndex > 0) {
        saveCurrentResponses(false); // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¿å­˜
        currentImageIndex--;
        loadCurrentImage();
        restoreResponses();
      }
    }

    function saveCurrentResponses(validate = true) {
      const imageId = imageIds[currentImageIndex];
      const imageData = riskData[imageId];
      const assessments = {};
      const unanswered = [];

      // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
      const agentsToDisplay = getAgentsToDisplay(imageId);

      // ã¾ãšå…¨ã¦ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.rating-group.error').forEach(el => el.classList.remove('error'));

      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        if (!reason) continue;

        const agreeInput = document.querySelector(`input[name="agree-${imageId}-${agentKey}"]:checked`);
        const thoughtInput = CONFIG.SIMPLIFY_THOUGHT ? null : document.querySelector(`input[name="thought-${imageId}-${agentKey}"]:checked`);

        if (validate) {
          if (!agreeInput) {
            unanswered.push({ type: 'agree', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
          if (!CONFIG.SIMPLIFY_THOUGHT && !thoughtInput) {
            unanswered.push({ type: 'thought', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
        }

        assessments[agentKey] = {
          displayName: AGENT_DISPLAY_NAMES[agentKey] || agentKey,
          judge: agentData.updated_judge_01 || agentData.risk_judge,
          agreeRating: agreeInput ? parseInt(agreeInput.value) : null,
          thoughtRating: thoughtInput ? parseInt(thoughtInput.value) : null
        };
      }

      // æœªå›ç­”ãŒã‚ã‚‹å ´åˆ
      if (validate && unanswered.length > 0) {
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        unanswered.forEach(item => {
          const groupId = `${item.type}-group-${imageId}-${item.agentKey}`;
          const group = document.getElementById(groupId);
          if (group) {
            group.classList.add('error');
          }
        });

        // æœ€åˆã®æœªå›ç­”ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        const firstError = unanswered[0];
        const firstGroupId = `${firstError.type}-group-${imageId}-${firstError.agentKey}`;
        const firstGroup = document.getElementById(firstGroupId);
        if (firstGroup) {
          firstGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        showUnansweredAlert(unanswered.length);
        return false;
      }

      // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã¾ãŸã¯è¿½åŠ 
      const existingIndex = surveyData.validityResults.findIndex(r => r.imageId === imageId);
      const resultData = { imageId, room: 'Kitchen', assessments };

      if (existingIndex >= 0) {
        surveyData.validityResults[existingIndex] = resultData;
      } else {
        surveyData.validityResults.push(resultData);
      }

      return true;
    }

    function restoreResponses() {
      const imageId = imageIds[currentImageIndex];
      const existingResult = surveyData.validityResults.find(r => r.imageId === imageId);

      if (existingResult) {
        for (const [agentKey, assessment] of Object.entries(existingResult.assessments)) {
          if (assessment.agreeRating) {
            const agreeInput = document.getElementById(`agree-${imageId}-${agentKey}-${assessment.agreeRating}`);
            if (agreeInput) agreeInput.checked = true;
          }
          if (assessment.thoughtRating) {
            const thoughtInput = document.getElementById(`thought-${imageId}-${agentKey}-${assessment.thoughtRating}`);
            if (thoughtInput) thoughtInput.checked = true;
          }
        }
      }
    }

    // ============================================
    // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡
    // ============================================

    function startTaskPlanningPhase() {
      console.log('=== ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ===');
      console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿:', taskPlanningData);
      console.log('è©•ä¾¡å¯¾è±¡ç”»åƒID:', imageIds);
      console.log('ç”»åƒãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:', imageBasePaths);

      // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒå­˜åœ¨ã™ã‚‹ç”»åƒIDã®ã¿ã‚’æŠ½å‡º
      taskPlanningImageIds = imageIds.filter(imageId => {
        const basePath = imageBasePaths[imageId];
        // LivingLabã®å ´åˆã¯å…ƒã®prediction_idã‚’è¨ˆç®—
        let predictionId = imageId;
        if (basePath === 'LivingLab') {
          const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
          predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
        }
        const hasTaskPlan = taskPlanningData[basePath] && taskPlanningData[basePath][predictionId];
        console.log(`ç”»åƒID ${imageId} (${basePath}, predictionId: ${predictionId}): ã‚¿ã‚¹ã‚¯è¨ˆç”»${hasTaskPlan ? 'ã‚ã‚Š' : 'ãªã—'}`);
        return hasTaskPlan;
      });

      console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡å¯¾è±¡ç”»åƒID:', taskPlanningImageIds);

      if (taskPlanningImageIds.length === 0) {
        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒãªã„å ´åˆã¯å®Œäº†ãƒšãƒ¼ã‚¸ã¸
        console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å®Œäº†ãƒšãƒ¼ã‚¸ã¸é·ç§»ã—ã¾ã™');
        finishSurvey();
        return;
      }

      console.log(`ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã—ã¾ã™ï¼ˆ${taskPlanningImageIds.length}æšã®ç”»åƒï¼‰`);
      currentTaskPlanningIndex = 0;
      document.getElementById('phase-validity').classList.add('hidden');
      document.getElementById('phase-task-planning').classList.remove('hidden');
      loadCurrentTaskPlanning();
    }

    // ============================================
    // 1. ã‚¿ã‚¹ã‚¯è¨ˆç”»ç”»é¢ã®è¡¨ç¤º (loadCurrentTaskPlanning)
    // ============================================
    function loadCurrentTaskPlanning() {
      if (currentTaskPlanningIndex >= taskPlanningImageIds.length) {
        finishSurvey();
        return;
      }

      const imageId = taskPlanningImageIds[currentTaskPlanningIndex];
      const imageData = riskData[imageId];
      const basePath = imageBasePaths[imageId];
      const container = document.getElementById('phase-task-planning');

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = ((currentTaskPlanningIndex) / taskPlanningImageIds.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      let progressText = `Task Planning: ${currentTaskPlanningIndex + 1} / ${taskPlanningImageIds.length}`;
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        progressText = `Group ${surveyData.assignedGroup + 1}: ${progressText}`;
      }
      document.getElementById('progress-text').textContent = progressText;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      skipValidationEnabled = false;
      skipValidationClickCount = 0;

      // LivingLabã®å ´åˆã¯å…ƒã®prediction_idã‚’è¨ˆç®—
      let predictionId = imageId;
      if (basePath === 'LivingLab') {
        const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
        predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
      }

      const taskPlanEntry = taskPlanningData[basePath][predictionId];
      if (!taskPlanEntry) {
        currentTaskPlanningIndex++;
        loadCurrentTaskPlanning();
        return;
      }

      // è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
      const agentsToDisplay = getAgentsToDisplay(imageId);

      // ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—
      const paths = imagePaths[imageId] || [];
      const firstImagePath = paths.length > 0 ? paths[0] : null;
      const imageSrc = firstImagePath
        ? `${CONFIG.IMAGE_BASE_PATHS[basePath]}${firstImagePath}`
        : `https://via.placeholder.com/600x400?text=Image+${imageId}`;
      const imageLabel = `${basePath} - Image ${imageId}${paths.length > 1 ? ` (Showing 1 of ${paths.length} images)` : ''}`;

      // Group info
      let groupInfo = '';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        groupInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Group ${surveyData.assignedGroup + 1}/${totalGroups} (Evaluating ${taskPlanningImageIds.length} of ${allImageIds.length} images)</p>`;
      }

      let html = `
        <div class="section-header" style="background: linear-gradient(135deg, #1976d2, #42a5f5);">
          <h2>Task Planning Evaluation for Image ${imageId}</h2>
          <p>${currentTaskPlanningIndex + 1} / ${taskPlanningImageIds.length}</p>
          ${groupInfo}
        </div>

        <div class="image-section">
          <img src="${imageSrc}" alt="Image ${imageId}" onerror="this.src='https://via.placeholder.com/600x400?text=Image+${imageId}'">

        </div>
      `;

      // å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      for (const agentKey of agentsToDisplay) {
        // ãƒªã‚¹ã‚¯è©•ä¾¡ãƒ‡ãƒ¼ã‚¿
        const agentData = imageData[agentKey];
        if (!agentData) continue;
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        const judge = agentData.updated_judge_01 || agentData.risk_judge;
        if (!reason) continue;

        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿
        const agentTaskData = taskPlanEntry[agentKey];
        if (!agentTaskData || !agentTaskData.task) continue;

        const displayName = AGENT_DISPLAY_NAMES[agentKey] || agentKey;
        const badgeClass = getBadgeClass(judge);

        html += `
          <div class="agent-card">
            <div class="agent-header">
              <span class="agent-badge">${displayName}</span>
              <span class="risk-badge ${badgeClass}">${getRiskLabel(judge)}</span>
            </div>
            <div class="agent-reason"><strong>Risk Reason:</strong><br>${reason}</div>
            
            <div style="background: #e8f0fe; padding: 16px; border-radius: 8px; margin-top: 16px; margin-bottom: 20px; border-left: 4px solid #1967d2;">
              <p style="font-weight: 500; margin-bottom: 8px; color: #1967d2;">ğŸ“ Proposed Task Plan:</p>
              <p style="margin-bottom: 12px; color: #202124; font-weight: 500;">${agentTaskData.task}</p>

            </div>
            
            <div class="rating-group" id="task-agree-group-${imageId}-${agentKey}">
              <div class="rating-label">
                1. Intuitive Agreement<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('task-agree-help-${imageId}-${agentKey}')">Evaluation criteria</span>
              </div>
              <div class="help-content" id="task-agree-help-${imageId}-${agentKey}">
                <strong>Question:</strong> Does the task plan proposed by the system match your intuition?<br>
                <strong>Purpose:</strong> Measure the correctness of the final planning result.<br><br>
                <strong>Evaluation Criteria:</strong>
                <ul>
                  <li><strong>5 - Very convincing</strong>: I would plan almost the same way</li>
                  <li><strong>4 - Mostly convincing</strong>: Generally agree, but some minor concerns</li>
                  <li><strong>3 - Neutral</strong>: Hard to say if it's good or bad</li>
                  <li><strong>2 - Somewhat unconvincing</strong>: Slightly different from my intuition</li>
                  <li><strong>1 - Not convincing at all</strong>: Completely different / Off-target</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">Does the task plan match your intuition?</p>
              <div class="rating-options">
                ${AGREE_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="task-agree-${imageId}-${agentKey}" id="task-agree-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="task-agree-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">Please answer this question</div>
            </div>

            <div class="rating-group" id="task-thought-group-${imageId}-${agentKey}">
              <div class="rating-label">
                2. Validity & Diversity of Rationale<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('task-thought-help-${imageId}-${agentKey}')">Evaluation criteria</span>
              </div>
              <div class="help-content" id="task-thought-help-${imageId}-${agentKey}">
                <strong>Question:</strong> Is the logic and action details of the task appropriate and sufficient?<br>
                <strong>Purpose:</strong> Measure the quality of the planning process.<br><br>
                <strong>Evaluation Criteria:</strong>
                <ul>
                  <li><strong>5 - Overly reactive</strong>: Overreacting to minor risks with excessive measures</li>
                  <li><strong>4 - Somewhat overthinking</strong>: Logic is sound, but includes unnecessary steps</li>
                  <li><strong>3 - Appropriate and multifaceted</strong>: Well-balanced planning for the situation</li>
                  <li><strong>2 - Insufficient rationale</strong>: Lacks explanation of why actions are needed</li>
                  <li><strong>1 - Inappropriate/irrelevant rationale</strong>: Includes unrelated actions</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">Is the task plan content appropriate?</p>
              <div class="rating-options">
                ${THOUGHT_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="task-thought-${imageId}-${agentKey}" id="task-thought-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="task-thought-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">Please answer this question</div>
            </div>
          </div>
        `;
      }

      html += `
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevTaskPlanning()" ${currentTaskPlanningIndex === 0 ? 'disabled' : ''}>Back</button>
          <button class="btn btn-primary" onclick="nextTaskPlanning()">${currentTaskPlanningIndex >= taskPlanningImageIds.length - 1 ? 'Finish' : 'Next'}</button>
        </div>
      `;

      container.innerHTML = html;
      restoreTaskPlanningResponses(imageId);
      window.scrollTo(0, 0);

      // éš ã—ã‚³ãƒãƒ³ãƒ‰: ãƒšãƒ¼ã‚¸ã®ç©ºã„ã¦ã„ã‚‹å ´æ‰€ã‚’5å›ä»¥ä¸Šã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—
      // (Risk Evaluationã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
      const containerElement = document.getElementById('phase-task-planning');
      if (containerElement) {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const newContainerElement = containerElement.cloneNode(true);
        containerElement.parentNode.replaceChild(newContainerElement, containerElement);

        newContainerElement.addEventListener('click', function (e) {
          // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ä»¥å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
          const isFormElement = e.target.tagName === 'INPUT' ||
            e.target.tagName === 'BUTTON' ||
            e.target.tagName === 'LABEL' ||
            e.target.closest('.rating-option') ||
            e.target.closest('.btn') ||
            e.target.closest('.help-toggle') ||
            e.target.closest('.help-content');

          if (!isFormElement) {
            skipValidationClickCount++;
            if (skipValidationClickCount >= 5 && !skipValidationEnabled) {
              skipValidationEnabled = true;
              console.log('éš ã—ã‚³ãƒãƒ³ãƒ‰æœ‰åŠ¹åŒ–: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€²ã‚ã¾ã™ (Task Planning)');
              // è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
              newContainerElement.style.border = '3px solid #1976d2';
              newContainerElement.style.transition = 'border 0.3s';
              setTimeout(() => {
                newContainerElement.style.border = '';
              }, 1000);
            }
          }
        });
      }
    }

    // ============================================
    // 2. ã‚¿ã‚¹ã‚¯è¨ˆç”»å›ç­”ã®ä¿å­˜ (saveTaskPlanningResponses)
    // ============================================
    function saveTaskPlanningResponses(validate = true) {
      // éš ã—ã‚³ãƒãƒ³ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (skipValidationEnabled) {
        validate = false;
      }
      const imageId = taskPlanningImageIds[currentTaskPlanningIndex];
      const imageData = riskData[imageId];
      const basePath = imageBasePaths[imageId];

      let predictionId = imageId;
      if (basePath === 'LivingLab') {
        const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
        predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
      }

      const taskPlan = taskPlanningData[basePath][predictionId];
      if (!taskPlan) return true;

      const agentsToDisplay = getAgentsToDisplay(imageId);
      const assessments = {};
      const unanswered = [];

      document.querySelectorAll('.rating-group.error').forEach(el => el.classList.remove('error'));

      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        if (!reason) continue;

        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ãŸã‚ï¼‰
        if (!taskPlan[agentKey]) continue;

        // nameå±æ€§ã‚’ 'task-agree-...' ã¨ 'task-thought-...' ã«å¤‰æ›´ã—ã¦ã„ã¾ã™
        const agreeInput = document.querySelector(`input[name="task-agree-${imageId}-${agentKey}"]:checked`);
        const thoughtInput = document.querySelector(`input[name="task-thought-${imageId}-${agentKey}"]:checked`);

        if (validate) {
          if (!agreeInput) {
            unanswered.push({ type: 'agree', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
          if (!thoughtInput) {
            unanswered.push({ type: 'thought', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
        }

        assessments[agentKey] = {
          displayName: AGENT_DISPLAY_NAMES[agentKey] || agentKey,
          agreeRating: agreeInput ? parseInt(agreeInput.value) : null,
          thoughtRating: thoughtInput ? parseInt(thoughtInput.value) : null
        };
      }

      if (validate && unanswered.length > 0) {
        unanswered.forEach(item => {
          const groupId = `task-${item.type}-group-${imageId}-${item.agentKey}`;
          const group = document.getElementById(groupId);
          if (group) {
            group.classList.add('error');
          }
        });

        const firstError = unanswered[0];
        const firstGroupId = `task-${firstError.type}-group-${imageId}-${firstError.agentKey}`;
        const firstGroup = document.getElementById(firstGroupId);
        if (firstGroup) {
          firstGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        showUnansweredAlert(unanswered.length);
        return false;
      }

      const existingIndex = surveyData.taskPlanningResults.findIndex(r => r.imageId === imageId);
      const result = {
        imageId: imageId,
        room: basePath,
        riskPredictionId: predictionId,
        task: taskPlan.task,
        action: taskPlan.action,
        assessments: assessments
      };

      if (existingIndex >= 0) {
        surveyData.taskPlanningResults[existingIndex] = result;
      } else {
        surveyData.taskPlanningResults.push(result);
      }

      return true;
    }

    // ============================================
    // 3. ã‚¿ã‚¹ã‚¯è¨ˆç”»å›ç­”ã®å¾©å…ƒ (restoreTaskPlanningResponses)
    // ============================================
    function restoreTaskPlanningResponses(imageId) {
      const existingResult = surveyData.taskPlanningResults.find(r => r.imageId === imageId);

      if (existingResult && existingResult.assessments) {
        for (const [agentKey, assessment] of Object.entries(existingResult.assessments)) {
          if (assessment.agreeRating) {
            const agreeInput = document.getElementById(`task-agree-${imageId}-${agentKey}-${assessment.agreeRating}`);
            if (agreeInput) agreeInput.checked = true;
          }
          if (assessment.thoughtRating) {
            const thoughtInput = document.getElementById(`task-thought-${imageId}-${agentKey}-${assessment.thoughtRating}`);
            if (thoughtInput) thoughtInput.checked = true;
          }
        }
      }
    }

    // ============================================
    // 4. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€ä¿¡ (sendToSpreadsheet)
    // ============================================
    async function sendToSpreadsheet() {
      const endpoint = CONFIG.SPREADSHEET_ENDPOINT;

      if (!endpoint || endpoint.trim() === '') {
        showSpreadsheetStatus('ã‚¨ãƒ©ãƒ¼: Google Spreadsheetã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
        return;
      }

      const btn = document.getElementById('btn-send-spreadsheet');
      const statusDiv = document.getElementById('spreadsheet-status');

      btn.disabled = true;
      btn.textContent = 'sending...';
      statusDiv.style.display = 'block';
      statusDiv.style.backgroundColor = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.textContent = 'Sending...';

      try {
        // Validityãƒ‡ãƒ¼ã‚¿ (Phase 1)
        const validityData = [];
        for (const result of surveyData.validityResults) {
          for (const [agentKey, assessment] of Object.entries(result.assessments)) {
            if (assessment.agreeRating !== null || assessment.thoughtRating !== null) {
              validityData.push({
                imageId: result.imageId,
                room: result.room,
                agentId: agentKey,
                judge: assessment.judge || '',
                agreeRating: assessment.agreeRating || null,
                thoughtRating: assessment.thoughtRating || null
              });
            }
          }
        }

        // Task Planningãƒ‡ãƒ¼ã‚¿ (Phase 2)
        // â€»GASå´ã‚’å¤‰æ›´ã—ãªãã¦æ¸ˆã‚€ã‚ˆã†ã€æ–°ã—ã„ã€Œç´å¾—æ„Ÿã€ã‚’validityRatingã«ã€ã€Œæ ¹æ‹ ã€ã‚’feasibilityRatingã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦é€ä¿¡ã—ã¾ã™
        const taskPlanningDataForSpreadsheet = [];
        for (const result of surveyData.taskPlanningResults) {
          if (result.assessments) {
            for (const [agentKey, assessment] of Object.entries(result.assessments)) {
              taskPlanningDataForSpreadsheet.push({
                imageId: result.imageId,
                room: result.room,
                riskPredictionId: result.riskPredictionId,
                agentId: agentKey,
                // ãƒãƒƒãƒ”ãƒ³ã‚°: ç›´æ„Ÿçš„ç´å¾—æ„Ÿ -> validityRating (Sheetåˆ—å: å¦¥å½“æ€§)
                validityRating: assessment.agreeRating || null,
                // ãƒãƒƒãƒ”ãƒ³ã‚°: æ ¹æ‹ ã®å¤šè§’æ€§ -> feasibilityRating (Sheetåˆ—å: å®Ÿè¡Œå¯èƒ½æ€§)
                feasibilityRating: assessment.thoughtRating || null
              });
            }
          }
        }

        const payload = {
          participant: {
            name: surveyData.participant.name,
            email: surveyData.participant.email || '',
            startTime: surveyData.participant.startTime,
            endTime: surveyData.participant.endTime
          },
          coverage: [],
          validity: validityData,
          taskPlanning: taskPlanningDataForSpreadsheet
        };

        console.log('é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', payload);

        let response;
        try {
          response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (fetchError) {
          console.warn('CORSã‚¨ãƒ©ãƒ¼(é€šå¸¸):', fetchError);
          // no-corsãƒªãƒˆãƒ©ã‚¤
          try {
            await fetch(endpoint, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            await new Promise(resolve => setTimeout(resolve, 2000));
            statusDiv.style.backgroundColor = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = `âœ…Finished!<br><small>Validity: ${validityData.length}ä»¶, Task: ${taskPlanningDataForSpreadsheet.length}ä»¶</small>`;
            btn.textContent = 'âœ… Send Complete';
            const warningText = document.getElementById('warning-text');
            if (warningText) {
              warningText.innerHTML = 'Send Complete! Please close the page';
              warningText.style.color = '#137333'; // Green color
            }
          } catch (noCorsError) {
            throw new Error(`Send failed: ${noCorsError.message}`);
          }
          return;
        }

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            statusDiv.style.backgroundColor = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `âœ… Send Success!<br><small>Participant: ${result.participant}<br>Validity: ${validityData.length}ä»¶<br>Task: ${taskPlanningDataForSpreadsheet.length}ä»¶</small>`;
            btn.textContent = 'âœ… Send Complete';
          } else {
            throw new Error(result.error || 'Send failed');
          }
        } else {
          throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }

      } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'ğŸ“Š å†é€ä¿¡';
      }
    }

    function nextTaskPlanning() {
      if (!saveTaskPlanningResponses()) {
        return;
      }
      currentTaskPlanningIndex++;
      loadCurrentTaskPlanning();
    }

    function prevTaskPlanning() {
      if (currentTaskPlanningIndex > 0) {
        saveTaskPlanningResponses(false);
        currentTaskPlanningIndex--;
        loadCurrentTaskPlanning();
      }
    }

    // ============================================
    // å®Œäº†
    // ============================================

    function finishSurvey() {
      surveyData.participant.endTime = new Date().toISOString();

      document.getElementById('progress-container').classList.add('hidden');
      document.getElementById('phase-validity').classList.add('hidden');
      document.getElementById('phase-task-planning').classList.add('hidden');
      document.getElementById('phase-complete').classList.remove('hidden');
    }

    // ============================================
    // Google Spreadsheeté€ä¿¡
    // ============================================

    async function sendToSpreadsheet() {
      const endpoint = CONFIG.SPREADSHEET_ENDPOINT;

      if (!endpoint || endpoint.trim() === '') {
        showSpreadsheetStatus('ã‚¨ãƒ©ãƒ¼: Google Spreadsheetã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CONFIG.SPREADSHEET_ENDPOINTã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      const btn = document.getElementById('btn-send-spreadsheet');
      const statusDiv = document.getElementById('spreadsheet-status');

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      btn.disabled = true;
      btn.textContent = 'Sending...';
      statusDiv.style.display = 'block';
      statusDiv.style.backgroundColor = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.textContent = 'Sending to Google Spreadsheet...';

      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚’Google Apps ScriptãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«å¤‰æ›
        const validityData = [];
        for (const result of surveyData.validityResults) {
          for (const [agentKey, assessment] of Object.entries(result.assessments)) {
            if (assessment.agreeRating !== null || assessment.thoughtRating !== null) {
              validityData.push({
                imageId: result.imageId,
                room: result.room,
                agentId: agentKey,
                judge: assessment.judge || '',
                agreeRating: assessment.agreeRating || null,
                thoughtRating: assessment.thoughtRating || null
              });
            }
          }
        }

        // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ï¼‰
        const taskPlanningDataForSpreadsheet = [];
        for (const result of surveyData.taskPlanningResults) {
          if (result.assessments) {
            for (const [agentKey, assessment] of Object.entries(result.assessments)) {
              taskPlanningDataForSpreadsheet.push({
                imageId: result.imageId,
                room: result.room,
                riskPredictionId: result.riskPredictionId,
                agentId: agentKey,
                // ãƒãƒƒãƒ”ãƒ³ã‚°: ç›´æ„Ÿçš„ç´å¾—æ„Ÿ -> validityRating (Sheetåˆ—å: å¦¥å½“æ€§)
                validityRating: assessment.agreeRating || null,
                // ãƒãƒƒãƒ”ãƒ³ã‚°: æ ¹æ‹ ã®å¤šè§’æ€§ -> feasibilityRating (Sheetåˆ—å: å®Ÿè¡Œå¯èƒ½æ€§)
                feasibilityRating: assessment.thoughtRating || null
              });
            }
          }
        }

        const payload = {
          participant: {
            name: surveyData.participant.name,
            email: surveyData.participant.email || '',
            startTime: surveyData.participant.startTime,
            endTime: surveyData.participant.endTime
          },
          coverage: [], // Coverageè©•ä¾¡ã¯ç¾åœ¨å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ç©ºé…åˆ—
          validity: validityData,
          taskPlanning: taskPlanningDataForSpreadsheet
        };

        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        console.log('é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', payload);
        console.log('Validityãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', validityData.length);
        console.log('TaskPlanningãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', taskPlanningDataForSpreadsheet.length);
        console.log('ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:', endpoint);

        // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        let response;
        try {
          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });
        } catch (fetchError) {
          console.warn('CORSã‚¨ãƒ©ãƒ¼(é€šå¸¸):', fetchError);
          // no-corsãƒªãƒˆãƒ©ã‚¤
          try {
            await fetch(endpoint, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            await new Promise(resolve => setTimeout(resolve, 2000));

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆno-corsï¼‰
            statusDiv.style.backgroundColor = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = `âœ…Send<br><small>Validity: ${validityData.length}ä»¶, Task: ${taskPlanningDataForSpreadsheet.length}ä»¶</small>`;
            btn.textContent = 'âœ… Send Complete';

            const warningText = document.getElementById('warning-text');
            if (warningText) {
              warningText.innerHTML = 'Send Complete! Please close the page';
              warningText.style.color = '#137333'; // Green color
            }
          } catch (noCorsError) {
            console.error('no-corsãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼:', noCorsError);
            throw new Error(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${noCorsError.message}`);
          }
          return;
        }

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status, response.statusText);

        if (response.ok) {
          const result = await response.json();
          console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', result);

          if (result.success) {
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            statusDiv.style.backgroundColor = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `âœ… Send Success!<br><small>Participant: ${result.participant || surveyData.participant.name}<br>Validity: ${result.validityCount || validityData.length}<br>Task: ${taskPlanningDataForSpreadsheet.length}</small>`;
            btn.textContent = 'âœ… Send Complete';
            const warningText = document.getElementById('warning-text');
            if (warningText) {
              warningText.innerHTML = 'Send Complete! Please close the page';
              warningText.style.color = '#137333'; // Green color
            }
          } else {
            throw new Error(result.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          const errorText = await response.text();
          console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
          throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
        }

      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `âŒ Send Error: ${error.message}<br><small>é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${validityData.length}ä»¶ã®Validityè©•ä¾¡, ${taskPlanningDataForSpreadsheet.length}ä»¶ã®Taskè©•ä¾¡<br>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${endpoint}<br><br>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:<br>1. Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>3. Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>4. CSVã¾ãŸã¯JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æ‰‹å‹•ã§Spreadsheetã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</small>`;
        btn.disabled = false;
        btn.textContent = 'ğŸ“Š Google Spreadsheetã«é€ä¿¡';
      }
    }

    function showSpreadsheetStatus(message, type = 'info') {
      const statusDiv = document.getElementById('spreadsheet-status');
      statusDiv.style.display = 'block';

      if (type === 'error') {
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
      } else if (type === 'success') {
        statusDiv.style.backgroundColor = '#d4edda';
        statusDiv.style.color = '#155724';
      } else {
        statusDiv.style.backgroundColor = '#fff3cd';
        statusDiv.style.color = '#856404';
      }

      statusDiv.textContent = message;
    }

    // ============================================
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    // ============================================

    function downloadJSON() {
      const dataStr = JSON.stringify(surveyData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `risk_evaluation_${surveyData.participant.name}_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadImagePaths() {
      // ã™ã¹ã¦ã®ç•ªå·ã«å¯¾ã™ã‚‹ç”»åƒãƒ‘ã‚¹ç¾¤ã‚’ã¾ã¨ã‚ã‚‹
      const imagePathsSummary = {};
      for (const imageId of allImageIds) {
        const paths = imagePaths[imageId] || [];
        const basePath = imageBasePaths[imageId] || 'Kitchen';
        const fullPaths = paths.map(path => `${CONFIG.IMAGE_BASE_PATHS[basePath]}${path}`);
        imagePathsSummary[imageId] = {
          base_path: basePath,
          image_count: paths.length,
          paths: paths,
          full_paths: fullPaths
        };
      }

      const dataStr = JSON.stringify(imagePathsSummary, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `image_paths_summary_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadCSV() {
      let csv = '\uFEFF'; // BOM for Excel
      csv += 'å‚åŠ è€…å,' + surveyData.participant.name + '\n';
      csv += 'é–‹å§‹æ™‚åˆ»,' + surveyData.participant.startTime + '\n';
      csv += 'çµ‚äº†æ™‚åˆ»,' + surveyData.participant.endTime + '\n';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        csv += 'å‰²ã‚Šå½“ã¦ã‚°ãƒ«ãƒ¼ãƒ—,ã‚°ãƒ«ãƒ¼ãƒ—' + (surveyData.assignedGroup + 1) + '/' + totalGroups + '\n';
        csv += 'è©•ä¾¡ç”»åƒæ•°,' + imageIds.length + 'æšï¼ˆå…¨' + allImageIds.length + 'æšä¸­ï¼‰\n';
      }
      csv += '\n';

      // ã‚µãƒãƒªãƒ¼å½¢å¼
      csv += '=== è©•ä¾¡ã‚µãƒãƒªãƒ¼ ===\n\n';

      // ãƒ˜ãƒƒãƒ€ãƒ¼
      csv += 'ç”»åƒID,';
      for (const agentKey of AGENT_KEYS) {
        csv += `${agentKey}_åŒæ„åº¦,${agentKey}_ç†Ÿæ…®åº¦,`;
      }
      csv += '\n';

      // ãƒ‡ãƒ¼ã‚¿
      for (const result of surveyData.validityResults) {
        csv += result.imageId + ',';
        for (const agentKey of AGENT_KEYS) {
          const assessment = result.assessments[agentKey];
          if (assessment) {
            csv += `${assessment.agreeRating || ''},${assessment.thoughtRating || ''},`;
          } else {
            csv += ',,';
          }
        }
        csv += '\n';
      }

      // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      if (surveyData.taskPlanningResults.length > 0) {
        csv += '\n=== ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ ===\n\n';
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        csv += 'ç”»åƒID,';
        for (const agentKey of AGENT_KEYS) {
          csv += `${agentKey}_å¦¥å½“æ€§,${agentKey}_å®Ÿè¡Œå¯èƒ½æ€§,`;
        }
        csv += '\n';

        // ãƒ‡ãƒ¼ã‚¿
        for (const result of surveyData.taskPlanningResults) {
          csv += result.imageId + ',';
          for (const agentKey of AGENT_KEYS) {
            const assessment = result.assessments && result.assessments[agentKey];
            if (assessment) {
              csv += `${assessment.validityRating || ''},${assessment.feasibilityRating || ''},`;
            } else {
              csv += ',,';
            }
          }
          csv += '\n';
        }
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `risk_evaluation_${surveyData.participant.name}_${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================

    function getBadgeClass(judge) {
      if (judge.includes('ç·Šæ€¥é‡å¤§')) return 'critical';
      if (judge.includes('æ½œåœ¨é‡å¤§')) return 'major';
      if (judge.includes('æ½œåœ¨è»½å¾®')) return 'minor';
      if (judge.includes('å¿ƒé…ãªã—') || judge.includes('ãƒªã‚¹ã‚¯ãªã—')) return 'none';
      return 'minor';
    }

    // ãƒªã‚¹ã‚¯ãƒ©ãƒ™ãƒ«ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªã«å¤‰æ›
    function getRiskLabel(judge) {
      if (judge.includes('ç·Šæ€¥é‡å¤§')) {
        return 'é‡å¤§ãªãƒªã‚¹ã‚¯ãŒã™ãã«èµ·ã“ã‚‹';
      }
      if (judge.includes('æ½œåœ¨é‡å¤§')) {
        return 'æ¡ä»¶ãŒæƒã†ã¨å¤§ããªãƒªã‚¹ã‚¯';
      }
      if (judge.includes('æ½œåœ¨è»½å¾®')) {
        return 'å°ã•ã‚ã®ãƒªã‚¹ã‚¯';
      }
      if (judge.includes('å¿ƒé…ãªã—') || judge.includes('ãƒªã‚¹ã‚¯ãªã—')) {
        return 'ã»ã¼å¿ƒé…ãªã—';
      }
      // ãã®ä»–ã®ãƒ©ãƒ™ãƒ«ã¯å…ƒã®æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾è¿”ã™
      return judge;
    }

    // ãƒ˜ãƒ«ãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    function toggleHelp(helpId) {
      const helpContent = document.getElementById(helpId);
      if (helpContent) {
        helpContent.classList.toggle('show');
      }
    }

    // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
    function clearError(input) {
      const group = input.closest('.rating-group');
      if (group) {
        group.classList.remove('error');
      }
      hideUnansweredAlert();
    }

    // æœªå›ç­”ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showUnansweredAlert(count) {
      let alert = document.getElementById('unanswered-alert');
      if (!alert) {
        alert = document.createElement('div');
        alert.id = 'unanswered-alert';
        alert.className = 'unanswered-alert';
        document.body.appendChild(alert);
      }
      alert.textContent = `âš ï¸ ${count} unanswered questions`;
      alert.classList.add('show');

      // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
      setTimeout(() => {
        hideUnansweredAlert();
      }, 5000);
    }

    // æœªå›ç­”ã‚¢ãƒ©ãƒ¼ãƒˆéè¡¨ç¤º
    function hideUnansweredAlert() {
      const alert = document.getElementById('unanswered-alert');
      if (alert) {
        alert.classList.remove('show');
      }
    }

    // ãŠã¿ãã˜ã‚’å¼•ãï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
    function drawOmikuji() {
      const resultEl = document.getElementById('omikuji-result');
      const noteEl = document.getElementById('omikuji-note');
      if (!resultEl) return;

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å‡¦ç†ãŒã‚ã‚Œã°ã“ã“ã«ï¼ˆä»Šå›ã¯çœç•¥ï¼‰

      let count = 0;
      const maxCount = 20; // 20å›åˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰æ­¢ã¾ã‚‹
      const interval = 100; // 100msã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆ

      const timer = setInterval(() => {
        const idx = Math.floor(Math.random() * OMIKUJI_RESULTS.length);
        const res = OMIKUJI_RESULTS[idx];
        resultEl.textContent = `Lottery... ã€${res.title}ã€‘ ${res.message}`;
        count++;

        if (count >= maxCount) {
          clearInterval(timer);
          // æœ€çµ‚çµæœã‚’æ±ºå®š
          const finalIdx = Math.floor(Math.random() * OMIKUJI_RESULTS.length);
          const finalRes = OMIKUJI_RESULTS[finalIdx];
          resultEl.innerHTML = `<span style="font-size: 1.2em; font-weight: bold; color: #e37400;">ğŸ‰ Result: ${finalRes.message}</span>`;
          if (noteEl) {
            noteEl.style.display = 'block';
          }
        }
      }, interval);
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>