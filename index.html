<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒªã‚¹ã‚¯äºˆæ¸¬è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #f0ebf8;
      min-height: 100vh;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .header-card {
      background: #fff;
      border-radius: 8px;
      border-top: 10px solid #673ab7;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .header-card h1 {
      font-size: 32px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 8px;
    }

    .header-card p {
      color: #5f6368;
      font-size: 14px;
    }

    .required-note {
      color: #d93025;
      font-size: 14px;
      margin-top: 16px;
    }

    /* è³ªå•ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      border-left: 4px solid transparent;
    }

    .card:focus-within {
      border-left-color: #673ab7;
    }

    .card-title {
      font-size: 16px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 16px;
    }

    .card-title .required {
      color: #d93025;
      margin-left: 4px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .section-header {
      background: linear-gradient(135deg, #673ab7, #9c27b0);
      color: white;
      border-radius: 8px;
      padding: 20px 24px;
      margin: 24px 0 12px 0;
    }

    .section-header h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .section-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .image-section {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      text-align: center;
    }

    .image-section img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .image-label {
      background: #673ab7;
      color: white;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 500;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› */
    input[type="text"],
    input[type="email"] {
      width: 100%;
      padding: 8px 0;
      border: none;
      border-bottom: 1px solid #dadce0;
      font-size: 16px;
      font-family: inherit;
      background: transparent;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-bottom: 2px solid #673ab7;
    }

    input[type="text"]::placeholder,
    input[type="email"]::placeholder {
      color: #80868b;
    }

    /* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚«ãƒ¼ãƒ‰ */
    .agent-card {
      background: #fff;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .agent-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .agent-badge {
      background: #673ab7;
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .risk-badge {
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }

    .risk-badge.critical { background: #fce8e6; color: #c5221f; }
    .risk-badge.major { background: #fef7e0; color: #e37400; }
    .risk-badge.minor { background: #e8f0fe; color: #1967d2; }
    .risk-badge.none { background: #e6f4ea; color: #137333; }

    .agent-reason {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #3c4043;
      margin-bottom: 20px;
      line-height: 1.7;
    }

    /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆ5æ®µéšè©•ä¾¡ï¼‰ */
    .rating-group {
      margin-bottom: 20px;
    }

    .rating-label {
      font-size: 14px;
      color: #202124;
      margin-bottom: 12px;
      display: block;
    }

    .rating-label .required {
      color: #d93025;
    }

    .rating-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rating-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .rating-option:hover {
      background: #f8f9fa;
    }

    .rating-option input[type="radio"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #5f6368;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }

    .rating-option input[type="radio"]:checked {
      border-color: #673ab7;
    }

    .rating-option input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: #673ab7;
      border-radius: 50%;
    }

    .rating-option label {
      font-size: 14px;
      color: #202124;
      cursor: pointer;
    }

    /* æœªå›ç­”ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .rating-group.error {
      background: #fce8e6;
      border-radius: 8px;
      padding: 12px;
      margin: -12px;
      margin-bottom: 8px;
      animation: shake 0.5s ease;
    }

    .rating-group.error .rating-label {
      color: #c5221f;
    }

    .error-message {
      color: #c5221f;
      font-size: 12px;
      margin-top: 8px;
      display: none;
    }

    .rating-group.error .error-message {
      display: block;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* ãƒ˜ãƒ«ãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .help-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #673ab7;
      cursor: pointer;
      margin-left: 8px;
      text-decoration: none;
      user-select: none;
    }

    .help-toggle:hover {
      text-decoration: underline;
    }

    .help-toggle::before {
      content: 'â„¹ï¸';
      font-size: 14px;
    }

    .help-content {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 3px solid #673ab7;
      border-radius: 4px;
      font-size: 12px;
      color: #5f6368;
    }

    .help-content.show {
      display: block;
    }

    .help-content ul {
      margin: 8px 0 0 16px;
      padding: 0;
    }

    .help-content li {
      margin-bottom: 4px;
    }

    /* æœªå›ç­”ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º */
    .unanswered-alert {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #c5221f;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 14px;
      display: none;
    }

    .unanswered-alert.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100%); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #f0ebf8;
      padding: 8px 0;
    }

    .progress-bar {
      height: 4px;
      background: #dadce0;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #673ab7;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 12px;
      color: #5f6368;
      margin-top: 4px;
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn-group {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #dadce0;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #673ab7;
      color: white;
    }

    .btn-primary:hover {
      background: #5e35b1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: transparent;
      color: #673ab7;
    }

    .btn-secondary:hover {
      background: #f3e5f5;
    }

    /* å®Œäº†ç”»é¢ */
    .complete-card {
      background: #fff;
      border-radius: 8px;
      border-top: 10px solid #673ab7;
      padding: 48px 24px;
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .complete-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .complete-card h2 {
      font-size: 24px;
      font-weight: 400;
      color: #202124;
      margin-bottom: 8px;
    }

    .complete-card p {
      color: #5f6368;
      margin-bottom: 24px;
    }

    .download-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* éè¡¨ç¤º */
    .hidden {
      display: none !important;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 48px;
      color: #5f6368;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #dadce0;
      border-top-color: #673ab7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <div class="progress-container hidden" id="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progress-text">0 / 0</div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>

    <!-- Intro: èª¬æ˜ãƒšãƒ¼ã‚¸ -->
    <div id="phase-intro" class="hidden">
      <div class="header-card">
        <h1>ãƒªã‚¹ã‚¯äºˆæ¸¬è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ã¤ã„ã¦</h1>
        <p style="margin-top: 8px;">
          ã“ã‚Œã¯ã€<strong>LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ãŒç”Ÿæˆã—ãŸã€Œå®¶åº­å†…äº‹æ•…ãƒªã‚¹ã‚¯ã®èª¬æ˜ã€</strong>ã«ã¤ã„ã¦ã€<br>
          <strong>ã‚ãªãŸã®ä¸»è¦³çš„ãªè©•ä¾¡</strong>ã‚’ãŠèãã™ã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ã™ã€‚
        </p>
      </div>

      <div class="card">
        <div class="card-title">ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§è¡Œã†ã“ã¨</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯ã€<strong>2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚
        </p>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px; margin-top: 12px;">
          <strong>ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªã‚¹ã‚¯è©•ä¾¡ã®è©•ä¾¡</strong><br>
          ãƒ»ç”»åƒã‚’1æšãšã¤è¦‹ãªãŒã‚‰ã€<strong>è¤‡æ•°ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</strong>ãŒç”Ÿæˆã—ãŸã€Œãƒªã‚¹ã‚¯ã®èª¬æ˜æ–‡ã€ã‚’èª­ã¿ã¾ã™ã€‚<br>
          ãƒ»ãã‚Œãã‚Œã®èª¬æ˜ã«ã¤ã„ã¦ã€<strong>ç›´æ„Ÿçš„ç´å¾—æ„Ÿ</strong>ã¨<strong>æ ¹æ‹ ã®å¦¥å½“æ€§ãƒ»å¤šè§’æ€§</strong>ã®2ã¤ã‚’ã€5æ®µéšã§è©•ä¾¡ã—ã¦ã„ãŸã ãã¾ã™ã€‚
        </p>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px; margin-top: 12px;">
          <strong>ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¿ã‚¹ã‚¯è¨ˆç”»ã®è©•ä¾¡</strong><br>
          ãƒ»ãƒªã‚¹ã‚¯è©•ä¾¡ã®å¾Œã€ãã®ãƒªã‚¹ã‚¯ã«å¯¾ã—ã¦AIãŒææ¡ˆã—ãŸã€Œå¯¾å‡¦æ–¹æ³•ï¼ˆã‚¿ã‚¹ã‚¯è¨ˆç”»ï¼‰ã€ã‚’ç¢ºèªã—ã¦ã„ãŸã ãã¾ã™ã€‚<br>
          ãƒ»ã‚¿ã‚¹ã‚¯è¨ˆç”»ã«ã¤ã„ã¦ã€<strong>å¦¥å½“æ€§ï¼ˆé©åˆ‡ã‹ã©ã†ã‹ï¼‰</strong>ã¨<strong>å®Ÿè¡Œå¯èƒ½æ€§ï¼ˆå®Ÿéš›ã«å®Ÿè¡Œã§ãã‚‹ã‹ã©ã†ã‹ï¼‰</strong>ã®2ã¤ã‚’ã€5æ®µéšã§è©•ä¾¡ã—ã¦ã„ãŸã ãã¾ã™ã€‚
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-top: 8px;">
          â€» èª¬æ˜æ–‡ã®ä¸­ã«ã¯ã€Œãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ã¦ã€œã€ã€Œå‰å›ã®è©•ä¾¡ã‚’ç¶­æŒã™ã‚‹ã€ãªã©ã€<br>
          ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒå£«ãŒé€£æºã—ã¦è­°è«–ã—ãŸå±¥æ­´ãŒãã®ã¾ã¾æ®‹ã£ã¦ã„ã‚‹è¡¨ç¾ãŒã‚ã‚Šã¾ã™ãŒã€<br>
          <strong>ãã†ã—ãŸå±¥æ­´ã®ç´°ã‹ã„äº‹æƒ…ã¯æ°—ã«ã›ãš</strong>ã€<strong>æœ€çµ‚çš„ãªæ–‡ç« å…¨ä½“ã‚’èª­ã‚“ã ã¨ãã®å°è±¡</strong>ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
        </p>
      </div>

      <div class="card">
        <div class="card-title">è©•ä¾¡ã®ã—ã‹ãŸï¼ˆ2ã¤ã®è©•ä¾¡è»¸ï¼‰</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          <strong>1. ç›´æ„Ÿçš„ç´å¾—æ„Ÿï¼ˆIntuitive Persuasivenessï¼‰</strong><br>
          è³ªå•ï¼šã€Œã‚·ã‚¹ãƒ†ãƒ ãŒä¸‹ã—ãŸãƒªã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªï¼ˆç·Šæ€¥é‡å¤§ã€œå®‰å…¨ï¼‰ã¯ã€ã‚ãªãŸã®ç›´æ„Ÿã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-bottom: 8px;">
          ç›®çš„ï¼šæœ€çµ‚çš„ãªã€Œåˆ¤å®šçµæœã€ã®æ­£ã—ã•ã‚’æ¸¬ã‚‹ã€‚
        </p>
        <ul style="font-size: 13px; color: #5f6368; margin-left: 16px; margin-bottom: 16px;">
          <li><strong>5 - éå¸¸ã«ç´å¾—ã§ãã‚‹ï¼ˆè‡ªåˆ†ã®æ„Ÿè¦šã¨åŒã˜ï¼‰</strong>ï¼šè‡ªåˆ†ãŒåˆ¤æ–­ã™ã‚‹ã¨ãã‚‚ã€ã»ã¼åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹</li>
          <li><strong>4 - æ¦‚ã­ç´å¾—ã§ãã‚‹</strong>ï¼šã ã„ãŸã„åŒæ„ã§ãã‚‹ãŒã€å°‘ã—æ°—ã«ãªã‚‹ç‚¹ãŒã‚ã‚‹</li>
          <li><strong>3 - ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„</strong>ï¼šè‰¯ã„ã¨ã‚‚æ‚ªã„ã¨ã‚‚åˆ¤æ–­ã—ã¥ã‚‰ã„</li>
          <li><strong>2 - ã‚ã¾ã‚Šç´å¾—ã§ããªã„</strong>ï¼šè‡ªåˆ†ã®æ„Ÿè¦šã¨ã¯å°‘ã—é•ã†</li>
          <li><strong>1 - å…¨ãç´å¾—ã§ããªã„ï¼ˆçš„å¤–ã‚Œï¼‰</strong>ï¼šè‡ªåˆ†ã®æ„Ÿè¦šã¨ã¯å…¨ãé•ã†ï¼å±é™ºã®æ‰ãˆæ–¹ãŒã‚ºãƒ¬ã¦ã„ã‚‹</li>
        </ul>

        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          <strong>2. æ ¹æ‹ ã®å¦¥å½“æ€§ãƒ»å¤šè§’æ€§ï¼ˆReasoning Balance / Logicï¼‰</strong><br>
          è³ªå•ï¼šã€Œãã®ãƒªã‚¹ã‚¯ã¨åˆ¤æ–­ã—ãŸã€ç†ç”±ã€ã®å†…å®¹ã¯ã€éä¸è¶³ãªãé©åˆ‡ã§ã™ã‹ï¼Ÿã€
        </p>
        <p style="font-size: 13px; color: #5f6368; margin-bottom: 8px;">
          ç›®çš„ï¼šæ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ã®ã€Œè³ªã€ã‚’æ¸¬ã‚‹ã€‚ã€Œè€ƒãˆã™ãï¼ˆéå‰°ï¼‰ã€ã¨ã€Œæ ¹æ‹ ä¸è¶³ï¼ˆéå°ï¼‰ã€ã‚’åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«ã§è©•ä¾¡ã§ãã¾ã™ã€‚
        </p>
        <ul style="font-size: 13px; color: #5f6368; margin-left: 16px;">
          <li><strong>5 - éå‰°ã«åå¿œã—ã™ãã¦ã„ã‚‹</strong>ï¼šéå¸¸ã«ä½ã„ç¢ºç‡ã®é€£é–ã‚’æ‡¸å¿µã—ã™ãã¦ã„ã‚‹</li>
          <li><strong>4 - ã‚„ã‚„è€ƒãˆã™ãã§ã‚ã‚‹</strong>ï¼šè«–ç†ã¯é€šã£ã¦ã„ã‚‹ãŒã€ãã“ã¾ã§å¿ƒé…ã—ãªãã¦ã‚‚è‰¯ã„å†…å®¹ã‚’å«ã‚€</li>
          <li><strong>3 - é©åˆ‡ã‹ã¤å¤šè§’çš„ã§ã‚ã‚‹</strong>ï¼šæ§˜ã€…ãªæƒ…å ±ãŒãƒãƒ©ãƒ³ã‚¹ã‚ˆãè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹</li>
          <li><strong>2 - æ ¹æ‹ ãŒä¸è¶³ã—ã¦ã„ã‚‹</strong>ï¼šç›´æ„Ÿçš„ã ãŒã€ãªãœãã†ãªã‚‹ã‹ã®èª¬æ˜ãŒè¶³ã‚Šãªã„</li>
          <li><strong>1 - æ ¹æ‹ ãŒä¸é©åˆ‡ãƒ»ç„¡é–¢ä¿‚</strong>ï¼šå…¨ãé–¢ä¿‚ãªã„ã“ã¨ã«è¨€åŠã—ã¦ã„ã‚‹</li>
        </ul>
        <p style="font-size: 13px; color: #5f6368; margin-top: 8px;">
          â€» æ–‡ç« ãŒé•·ã„ã‹ã‚‰ã¨ã„ã£ã¦ã€Œã‚ˆãè€ƒãˆã¦ã„ã‚‹ã€ã¨è©•ä¾¡ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
          <strong>é•·ã•ã§ã¯ãªãã€ã€Œçµè«–ã¨ç†ç”±ãŒè‡ªåˆ†ã®æ„Ÿè¦šã«åˆã£ã¦ã„ã‚‹ã‹ï¼Ÿã€ã€Œæ ¹æ‹ ãŒé©åˆ‡ã‹ï¼Ÿã€ã¨ã„ã†è¦³ç‚¹</strong>ã§ã€æ°—æ¥½ã«ç­”ãˆã¦ãã ã•ã„ã€‚
        </p>
      </div>

      <div class="card" id="grouping-info-card" style="display: none;">
        <div class="card-title">ç”»åƒã®ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã«ã¤ã„ã¦</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;" id="grouping-info-text">
          <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </p>
      </div>

      <div class="card">
        <div class="card-title">æ‰€è¦æ™‚é–“ã¨ãŠé¡˜ã„</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          ãƒ»ç”»åƒæšæ•°ã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°ãŒå¤šã„ãŸã‚ã€<strong>ã‚ã‚‹ç¨‹åº¦ã¾ã¨ã¾ã£ãŸæ™‚é–“ï¼ˆ30åˆ†ã€œ1æ™‚é–“ç¨‹åº¦ï¼‰</strong>ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚<br>
          ãƒ»é€”ä¸­ã§ç–²ã‚Œã¦ããŸã‚‰ã€<strong>ç„¡ç†ã‚’ã›ãšä¼‘æ†©ã—ãªãŒã‚‰</strong>å›ç­”ã—ã¦ãã ã•ã„ã€‚<br>
          ãƒ»ã™ã¹ã¦ã®è³ªå•ã«å®Œå…¨ã«ç­”ãˆãªãã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€<strong>ã§ãã‚‹ç¯„å›²ã§ä¸å¯§ã«è©•ä¾¡ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ã€ã¨ã¦ã‚‚åŠ©ã‹ã‚Šã¾ã™ã€‚</strong>
        </p>
      </div>

      <div class="card">
        <div class="card-title">ãŠæ¥½ã—ã¿è¦ç´ ï¼šãŠã¿ãã˜ï¼†æ™¯å“</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 8px;">
          å…¨ã¦ã®ç”»åƒã®è©•ä¾¡ãŒçµ‚ã‚ã‚‹ã¨ã€<strong>æœ€å¾Œã«ã€ŒãŠã¿ãã˜ã€</strong>ã‚’å¼•ã‘ã¾ã™ã€‚<br>
          ä»Šå¹´ã®é‹å‹¢ã‚’å ã£ã¦ã€ã¡ã‚‡ã£ã¨ã ã‘æ°—åˆ†è»¢æ›ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
        </p>
        <p style="font-size: 13px; color: #5f6368;">
          ãŠã¿ãã˜ã®çµæœã«å¿œã˜ã¦ã€<strong>å¹´æ˜ã‘ã«ã•ã•ã‚„ã‹ãªæ™¯å“</strong>ï¼ˆãŠè“å­ã‚„è¨˜å¿µå“ãªã©ï¼‰ã‚’ãŠæ¸¡ã—ã™ã‚‹äºˆå®šã§ã™ã€‚<br>
          çµæœã¯ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®é›†è¨ˆã¨ä¸€ç·’ã«ç¢ºèªã—ã¾ã™ã®ã§ã€ãŠæ¥½ã—ã¿ã«ï¼\n
        </p>
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <div></div>
        <button class="btn btn-primary" onclick="goToAgentExplanation()">èª¬æ˜ã‚’èª­ã‚“ã ã®ã§æ¬¡ã¸</button>      </div>
    </div>

    <div id="phase-agent-explanation" class="hidden">
      <div class="header-card">
        <h1>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ï¼Ÿ</h1>
        <p>ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ç™»å ´ã™ã‚‹ã€Œè©•ä¾¡è€…ãŸã¡ã€ã«ã¤ã„ã¦ã”èª¬æ˜ã—ã¾ã™ã€‚</p>
      </div>

      <div class="card">
        <div class="card-title">ğŸ¤– å˜ãªã‚‹ã€ŒAIã€ã¨ã€ŒAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ã®é•ã„</div>
        <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 16px;">
          <div style="font-size: 40px;">ğŸ’¬</div>
          <div>
            <strong>æ™®é€šã®ãƒãƒ£ãƒƒãƒˆAI</strong><br>
            <span style="font-size: 13px; color: #5f6368;">èã‹ã‚ŒãŸã“ã¨ã«ç­”ãˆã‚‹ã ã‘ã€‚æ€§æ ¼ã‚„ç«‹å ´ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚</span>
          </div>
        </div>
        <div style="text-align: center; font-size: 20px; color: #dadce0; margin: 8px 0;">â¬‡ï¸ é€²åŒ– â¬‡ï¸</div>
        <div style="display: flex; gap: 20px; align-items: center; margin-top: 16px;">
          <div style="font-size: 40px;">ğŸ•µï¸</div>
          <div>
            <strong>AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆä»Šå›ã®è©•ä¾¡è€…ï¼‰</strong><br>
            <span style="font-size: 13px; color: #5f6368;"><strong>ã€Œæ€§æ ¼ã€ã€Œå½¹å‰²ã€ã€Œå°‚é–€çŸ¥è­˜ã€</strong>ã‚’æŒã£ã¦ã„ã¾ã™ã€‚<br>
            ã€Œã‚‚ã—ç§ãŒå¿ƒé…æ€§ã®è¦ªã ã£ãŸã‚‰ï¼Ÿã€ã€Œã‚‚ã—ç§ãŒå³æ ¼ãªå®‰å…¨ç®¡ç†è€…ã ã£ãŸã‚‰ï¼Ÿã€ã¨ã„ã†ç«‹å ´ã«ãªã‚Šãã£ã¦ã€ãƒªã‚¹ã‚¯ã‚’è€ƒãˆã¾ã™ã€‚</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ãªãœè¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ¯”è¼ƒã™ã‚‹ã®ï¼Ÿ</div>
        <p style="font-size: 14px; color: #5f6368; margin-bottom: 12px;">
          ãƒªã‚¹ã‚¯ã®æ„Ÿã˜æ–¹ã¯äººãã‚Œãã‚Œã§ã™ã€‚<br>
          ä¾‹ãˆã°ã€<strong>ã€ŒåŒ…ä¸ãŒç½®ã„ã¦ã‚ã‚‹ã€</strong>ã¨ã„ã†çŠ¶æ³ã«å¯¾ã—ã¦ï¼š
        </p>
        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <ul style="list-style: none; padding: 0;">
            <li style="margin-bottom: 12px;">
              <span class="agent-badge">Agent A (æ™®é€š)</span> <span style="font-size: 14px;">ã€Œæ–™ç†ä¸­ãªã‚‰æ™®é€šã®ã“ã¨ã ã­ã€‚ãƒªã‚¹ã‚¯ãªã—ã€‚ã€</span>
            </li>
            <li style="margin-bottom: 12px;">
              <span class="agent-badge" style="background: #e37400;">Agent H (å³æ ¼)</span> <span style="font-size: 14px;">ã€Œåœ°éœ‡ã§è½ä¸‹ã—ã¦è¶³ã«åˆºã•ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚<strong>æ½œåœ¨çš„ãƒªã‚¹ã‚¯</strong>ã ï¼ã€</span>
            </li>
            <li>
              <span class="agent-badge" style="background: #c5221f;">Agent C (å¿ƒé…æ€§)</span> <span style="font-size: 14px;">ã€Œå­ä¾›ãŒæ‰‹ã‚’ä¼¸ã°ã™ã‹ã‚‚ã—ã‚Œãªã„ï¼<strong>ç·Šæ€¥ã®ãƒªã‚¹ã‚¯</strong>ã ï¼ã€</span>
            </li>
          </ul>
        </div>
        <p style="font-size: 14px; color: #5f6368;">
          ã“ã®ã‚ˆã†ã«ã€<strong>AIã®æ€§æ ¼ï¼ˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã«ã‚ˆã£ã¦ãƒªã‚¹ã‚¯åˆ¤æ–­ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</strong><br>
          ã©ã®AIã®åˆ¤æ–­ãŒã€Œäººé–“ï¼ˆã‚ãªãŸï¼‰ã®æ„Ÿè¦šã€ã«ä¸€ç•ªè¿‘ã„ã‹ã€ã‚ã‚‹ã„ã¯ã€Œå½¹ã«ç«‹ã¤ã‹ã€ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
        </p>
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <button class="btn btn-secondary" onclick="backToIntro()">æˆ»ã‚‹</button>
        <button class="btn btn-primary" onclick="goToNamePhase()">ç†è§£ã—ã¾ã—ãŸ</button>
      </div>
    </div>
    
    <!-- Phase 0: å‚åŠ è€…æƒ…å ± -->
    <div id="phase-name" class="hidden">
      <div class="header-card">
        <h1>ãƒªã‚¹ã‚¯äºˆæ¸¬è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
        <p>å®¶åº­å†…äº‹æ•…ãƒªã‚¹ã‚¯äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã®è©•ä¾¡ã«ã”å”åŠ›ãã ã•ã„ã€‚<br>
        ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ã¯ã€<strong>2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—</strong>ã§è©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>
        <p style="margin-top: 8px;">
          <strong>ã‚¹ãƒ†ãƒƒãƒ—1:</strong> å„ç”»åƒã«ã¤ã„ã¦ã€è¤‡æ•°ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’èª­ã¿ã€<strong>ç›´æ„Ÿçš„ç´å¾—æ„Ÿ</strong>ã¨<strong>æ ¹æ‹ ã®å¦¥å½“æ€§ãƒ»å¤šè§’æ€§</strong>ã‚’5æ®µéšã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚<br>
          <strong>ã‚¹ãƒ†ãƒƒãƒ—2:</strong> ãƒªã‚¹ã‚¯è©•ä¾¡ã®å¾Œã€AIãŒææ¡ˆã—ãŸå¯¾å‡¦æ–¹æ³•ï¼ˆã‚¿ã‚¹ã‚¯è¨ˆç”»ï¼‰ã«ã¤ã„ã¦ã€<strong>å¦¥å½“æ€§</strong>ã¨<strong>å®Ÿè¡Œå¯èƒ½æ€§</strong>ã‚’5æ®µéšã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
        </p>
        <p class="required-note">* ã¯å¿…é ˆé …ç›®ã§ã™</p>
      </div>

      <div class="card">
        <div class="card-title">ãŠåå‰<span class="required">*</span></div>
        <input type="text" id="participant-name" placeholder="å›ç­”ã‚’å…¥åŠ›" required>
      </div>

      <div class="card">
        <div class="card-title">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
        <input type="email" id="participant-email" placeholder="å›ç­”ã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰">
      </div>

      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <div></div>
        <button class="btn btn-primary" onclick="startSurvey()">æ¬¡ã¸</button>
      </div>
    </div>

    <!-- Phase 1: Validityè©•ä¾¡ -->
    <div id="phase-validity" class="hidden">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- Phase 2: ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ -->
    <div id="phase-task-planning" class="hidden">
      <!-- å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- Phase 3: å®Œäº† -->
    <div id="phase-complete" class="hidden">
      <div class="complete-card">
        <div class="complete-icon">âœ…</div>
        <h2>å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸ</h2>
        <p>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼</p>
        <div class="download-buttons" style="margin-bottom: 24px;">
          <button class="btn btn-primary" id="btn-send-spreadsheet" onclick="sendToSpreadsheet()" style="background-color: #34a853; color: white;">
            ğŸ“Š Google Spreadsheetã«é€ä¿¡
          </button>
          <button class="btn btn-secondary" onclick="downloadCSV()">CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          <button class="btn btn-secondary" onclick="downloadJSON()">JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          <button class="btn btn-secondary" onclick="downloadImagePaths()">ç”»åƒãƒ‘ã‚¹ä¸€è¦§ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
        <div id="spreadsheet-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>

        <div style="margin-top: 8px; margin-bottom: 24px;">
          <p style="color: #5f6368; margin-bottom: 8px;">
            ã“ã“ã¾ã§ãŠä»˜ãåˆã„ã„ãŸã ã„ãŸãŠç¤¼ã«ã€<strong>ä»Šå¹´ã®é‹å‹¢ã‚’å ã†ã€ŒãŠã¿ãã˜ã€</strong>ã‚’ã”ç”¨æ„ã—ã¾ã—ãŸã€‚
          </p>
          <button class="btn btn-primary" onclick="drawOmikuji()">ãŠã¿ãã˜ã‚’å¼•ã</button>
          <p id="omikuji-result" style="margin-top: 16px; font-size: 16px; color: #202124;"></p>
          <p id="omikuji-note" style="margin-top: 8px; font-size: 13px; color: #5f6368; display: none;">
            ãŠã¿ãã˜ã®çµæœã«å¿œã˜ã¦ã€<strong>å¹´æ˜ã‘ã«ã•ã•ã‚„ã‹ãªæ™¯å“</strong>ï¼ˆãŠè“å­ã‚„è¨˜å¿µå“ãªã©ï¼‰ã‚’ãŠæ¸¡ã—ã™ã‚‹äºˆå®šã§ã™ã€‚<br>
            çµæœã¯ç ”ç©¶è€…å´ã§é›†è¨ˆã—ã€å¾Œæ—¥ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // è¨­å®š
    // ============================================
    
    // ============================================
    // è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆã“ã“ã‚’å¤‰æ›´ã—ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‰
    // ============================================
    const CONFIG = {
      // è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰: 'ablation' | 'random' | 'all'
      // 'ablation': ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ï¼ˆ4-5ç¨®é¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã€æ¨å¥¨ï¼‰
      //              â†’ å›ç­”æ™‚é–“ãŒ1/3ã«çŸ­ç¸®ã€ç ”ç©¶ã®æ ¸å¿ƒã«é›†ä¸­
      // 'random': ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ1ç”»åƒã«ã¤ã3-4ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
      //           â†’ å›ç­”è€…ã”ã¨ã«ç•°ãªã‚‹çµ„ã¿åˆã‚ã›ã€å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®çµ±è¨ˆå–å¾—å¯èƒ½
      // 'all': å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¡¨ç¤ºï¼ˆ14ç¨®é¡ã™ã¹ã¦ï¼‰
      //        â†’ å°‘æ•°ã®å°‚é–€å®¶å‘ã‘ã€å›ç­”è² æ‹…ãŒå¤§ãã„
      EVALUATION_MODE: 'all',
      
      // ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ç”¨ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆç ”ç©¶ã®æ ¸å¿ƒï¼‰
      ABLATION_AGENTS: [
        'Semantic_state',                    // Agent A: åŸºæº–ç‚¹ï¼ˆLLMã®ã¿ï¼‰
        'Semantic_state_RiskScore',          // Agent B: ææ¡ˆæ‰‹æ³•ï¼ˆçµ±åˆå‹ï¼‰
        'Semantic_state_RiskScore_Persona_01', // Agent C: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã®æœ‰åŠ¹æ€§
        'Semantic_state_Stickler',           // Agent H: æ¯”è¼ƒå¯¾è±¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        'VLM'                                 // Agent N: æ—¢å­˜æ‰‹æ³•ã¨ã®æ¯”è¼ƒ
      ],
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ™‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ•°
      RANDOM_AGENT_COUNT: 4,
      
      // ç†Ÿæ…®åº¦ã‚’ç°¡ç•¥åŒ–ã™ã‚‹ã‹ï¼ˆtrue: åŒæ„åº¦ã®ã¿ã€false: ä¸¡æ–¹è©•ä¾¡ï¼‰
      // ç†Ÿå£«è«–æ–‡ã§ã¯ã€ŒåŒæ„åº¦ï¼‹ç†Ÿæ…®åº¦ã€ã®2è»¸ã§è©•ä¾¡ã™ã‚‹ãŸã‚ false ã«è¨­å®š
      SIMPLIFY_THOUGHT: false,
      
      // ç”»åƒã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘è¨­å®š
      ENABLE_GROUPING: true,  // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‹
      GROUP_SIZE: 3,          // ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®ç”»åƒæ•°
      
      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
      JSON_FILES: [
        './evaluation_dataset_Kitchen.json',
        './evaluation_dataset_LivingLab.json'
      ],
      // ã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
      TASK_PLANNING_FILES: [
        './Kitchen_task_planning_20251229_161805.json',
        './LivingLab_task_planning_20251229_162003.json'
      ],
      // ç”»åƒã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®šã€ã¾ãŸã¯çµ¶å¯¾ãƒ‘ã‚¹ï¼‰
      IMAGE_BASE_PATHS: {
        'Kitchen': './Kitchen/002_Observations/',
        'LivingLab': './Livinglab/002_Observations/'
      },
      
      // ç‰¹å®šã®IDã§é™¤å¤–ã™ã‚‹ç”»åƒãƒ‘ã‚¹
      EXCLUDED_IMAGE_PATHS: {
        '0': [
          'obs_20251227_042752_34a215e3/rgb.jpg',
          'obs_20251227_042806_b696a377/rgb.jpg'
        ],
        '2': [
          'obs_20251227_042752_34a215e3/rgb.jpg',
          'obs_20251227_043054_8ce47229/rgb.jpg',
          'obs_20251227_042806_b696a377/rgb.jpg'
        ],
        '3': [
          'obs_20251227_043054_8ce47229/rgb.jpg'
        ],
        '4': [
          'obs_20251227_042752_34a215e3/rgb.jpg'
        ],
        '5': [
          'obs_20251227_042926_368f4aab/rgb.jpg',
          'obs_20251227_043013_0201ff2a/rgb.jpg'
        ],
        '6': [
          'obs_20251227_042001_765b0f6a/rgb.jpg'
        ],
        '7': [
          'obs_20251227_042651_90f7ed19/rgb.jpg'
        ]
      },
      
      // Google Spreadsheeté€£æºè¨­å®š
      // Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„
      // è¨­å®šæ–¹æ³•: google_apps_script.gs ã‚’å‚ç…§
      SPREADSHEET_ENDPOINT: 'https://script.google.com/macros/s/AKfycbzW98z-PjOdpmv-ySBm7XDW6eOyKy6A8fVA2BgbcYi9gnYubPkO-lEhZafYBa8OB-CwXg/exec'  // ä¾‹: 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'
    };
    
    // å¯¾è±¡ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ¼ï¼ˆã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
    const AGENT_KEYS = [
      'Semantic_state',
      'Semantic_state_RiskScore',
      'Semantic_state_RiskScore_Persona_01',
      'Semantic_state_RiskScore_Persona_02',
      'Semantic_state_RiskScore_Persona_03',
      'Semantic_state_RiskScore_Persona_04',
      'Semantic_state_RiskScore_Persona_05',
      'Semantic_state_Stickler',
      'Semantic_state_Persona_01',
      'Semantic_state_Persona_02',
      'Semantic_state_Persona_03',
      'Semantic_state_Persona_04',
      'Semantic_state_Persona_05',
      'VLM'
    ];

    // åŒ¿ååŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå
    const AGENT_DISPLAY_NAMES = {
      'Semantic_state': 'Agent A',
      'Semantic_state_RiskScore': 'Agent B',
      'Semantic_state_RiskScore_Persona_01': 'Agent C',
      'Semantic_state_RiskScore_Persona_02': 'Agent D',
      'Semantic_state_RiskScore_Persona_03': 'Agent E',
      'Semantic_state_RiskScore_Persona_04': 'Agent F',
      'Semantic_state_RiskScore_Persona_05': 'Agent G',
      'Semantic_state_Stickler': 'Agent H',
      'Semantic_state_Persona_01': 'Agent I',
      'Semantic_state_Persona_02': 'Agent J',
      'Semantic_state_Persona_03': 'Agent K',
      'Semantic_state_Persona_04': 'Agent L',
      'Semantic_state_Persona_05': 'Agent M',
      'VLM': 'Agent N'
    };

    // 5æ®µéšè©•ä¾¡ã®é¸æŠè‚¢
    // 1. ç›´æ„Ÿçš„ç´å¾—æ„Ÿï¼ˆIntuitive Persuasivenessï¼‰
    const AGREE_CHOICES = [
      { value: 5, label: 'éå¸¸ã«ç´å¾—ã§ãã‚‹ï¼ˆè‡ªåˆ†ã®æ„Ÿè¦šã¨åŒã˜ï¼‰' },
      { value: 4, label: 'æ¦‚ã­ç´å¾—ã§ãã‚‹' },
      { value: 3, label: 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' },
      { value: 2, label: 'ã‚ã¾ã‚Šç´å¾—ã§ããªã„' },
      { value: 1, label: 'å…¨ãç´å¾—ã§ããªã„ï¼ˆçš„å¤–ã‚Œï¼‰' }
    ];

    // 2. æ ¹æ‹ ã®å¦¥å½“æ€§ãƒ»å¤šè§’æ€§ï¼ˆReasoning Balance / Logicï¼‰
    const THOUGHT_CHOICES = [
      { value: 5, label: 'éå‰°ã«åå¿œã—ã™ãã¦ã„ã‚‹ï¼ˆéå¸¸ã«ä½ã„ç¢ºç‡ã®ãƒªã‚¹ã‚¯ã‚’æ‡¸å¿µã—ã™ãã¦ã„ã‚‹ï¼‰' },
      { value: 4, label: 'ã‚„ã‚„è€ƒãˆã™ãã§ã‚ã‚‹ï¼ˆè«–ç†ã¯é€šã£ã¦ã„ã‚‹ãŒã€ãã“ã¾ã§å¿ƒé…ã—ãªãã¦ã‚‚è‰¯ã„å†…å®¹ã‚’å«ã‚€ï¼‰' },
      { value: 3, label: 'é©åˆ‡ã‹ã¤å¤šè§’çš„ã§ã‚ã‚‹ï¼ˆæ§˜ã€…ãªæƒ…å ±ãŒãƒãƒ©ãƒ³ã‚¹ã‚ˆãè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹ï¼‰' },
      { value: 2, label: 'æ ¹æ‹ ãŒä¸è¶³ã—ã¦ã„ã‚‹ï¼ˆç›´æ„Ÿçš„ã ãŒã€ãªãœãã†ãªã‚‹ã‹ã®èª¬æ˜ãŒè¶³ã‚Šãªã„ï¼‰' },
      { value: 1, label: 'æ ¹æ‹ ãŒä¸é©åˆ‡ãƒ»ç„¡é–¢ä¿‚ï¼ˆå…¨ãé–¢ä¿‚ãªã„ã“ã¨ã«è¨€åŠã—ã¦ã„ã‚‹ï¼‰' }
    ];

    // ãŠã¿ãã˜ã®çµæœå€™è£œ
    const OMIKUJI_RESULTS = [
      { title: 'å¤§å‰', message: 'æœ€é«˜ã®ä¸€å¹´ã«ãªã‚Šãã†ã§ã™ï¼æ–°ã—ã„æŒ‘æˆ¦ã«ã‚‚ãœã²å‰å‘ãã«ã€‚' },
      { title: 'ä¸­å‰', message: 'ç©ã‚„ã‹ã«è‰¯ã„ã“ã¨ãŒç©ã¿é‡ãªã‚‹ä¸€å¹´ã«ãªã‚Šãã†ã§ã™ã€‚ã‚³ãƒ„ã‚³ãƒ„å‹ãŒå‰ã€‚' },
      { title: 'å°å‰', message: 'å¤§ããªæ³¢ã¯ãªã„ã‚‚ã®ã®ã€åŠªåŠ›æ¬¡ç¬¬ã§ã—ã£ã‹ã‚Šå ±ã‚ã‚Œã‚‹ä¸€å¹´ã§ã™ã€‚' },
      { title: 'å‰',   message: 'æ—¥å¸¸ã®ä¸­ã®å°ã•ãªå¹¸ã›ã«æ°—ã¥ã‘ã‚‹ã¨ã€é‹æ°—ãŒã˜ã‚ã˜ã‚ä¸ŠãŒã£ã¦ã„ãã¾ã™ã€‚' },
      { title: 'æœ«å‰', message: 'ç„¡ç†ã‚’ã—ã™ããšã€ä½“èª¿ã¨æ°—åˆ†ã‚’å¤§äº‹ã«ã§ãã‚‹ã¨ã€è‰¯ã„æ–¹å‘ã«è»¢ãŒã£ã¦ã„ãã¾ã™ã€‚' },
      { title: 'å‡¶ï¼ˆãƒ¬ã‚¢ï¼‰', message: 'ãƒã‚¿æ ã®ã€Œå‡¶ã€ã§ã™ã€‚æ…é‡ã•ã¨ä¼‘æ¯ã‚’æ„è­˜ã™ã‚Œã°ã€ã‚€ã—ã‚è‰¯ã„ä¸€å¹´ã«ãªã‚‹ã‹ã‚‚ï¼Ÿ' }
    ];

    // ============================================
    // ãƒ‡ãƒ¼ã‚¿
    // ============================================
    
    let riskData = null;
    let surveyData = {
      participant: { name: '', email: '', startTime: null, endTime: null },
      assignedGroup: null,  // å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ï¼ˆ0å§‹ã¾ã‚Šï¼‰
      validityResults: [],
      taskPlanningResults: []  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡çµæœ
    };
    let currentImageIndex = 0;
    let currentTaskPlanningIndex = 0;  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã®ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let taskPlanningImageIds = [];  // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡å¯¾è±¡ã®ç”»åƒIDãƒªã‚¹ãƒˆ
    let imageIds = [];  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ç”»åƒIDãƒªã‚¹ãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å¾Œï¼‰
    let allImageIds = [];  // å…¨ç”»åƒIDãƒªã‚¹ãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å‰ï¼‰
    let imagePaths = {};  // å„ç•ªå·ã«å¯¾ã™ã‚‹ç”»åƒãƒ‘ã‚¹ç¾¤ { "0": ["path1", "path2", ...], ... }
    let imageBasePaths = {};  // å„ç•ªå·ã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ { "0": "Kitchen" or "LivingLab", ... }
    let taskPlanningData = {};  // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ { "Kitchen": { "0": {...}, ... }, "LivingLab": { "0": {...}, ... } }
    let skipValidationClickCount = 0;  // ã‚¯ãƒªãƒƒã‚¯å›æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆéš ã—ã‚³ãƒãƒ³ãƒ‰ç”¨ï¼‰
    let skipValidationEnabled = false;  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ï¼ˆéš ã—ã‚³ãƒãƒ³ãƒ‰ç”¨ï¼‰

    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    
    async function init() {
      try {
        // 2ã¤ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§èª­ã¿è¾¼ã‚€
        const [kitchenResponse, livinglabResponse, kitchenTaskResponse, livinglabTaskResponse] = await Promise.all([
          fetch(CONFIG.JSON_FILES[0]),
          fetch(CONFIG.JSON_FILES[1]),
          fetch(CONFIG.TASK_PLANNING_FILES[0]).catch(() => ({ ok: false })),
          fetch(CONFIG.TASK_PLANNING_FILES[1]).catch(() => ({ ok: false }))
        ]);
        
        if (!kitchenResponse.ok || !livinglabResponse.ok) {
          throw new Error(`HTTP error! Kitchen: ${kitchenResponse.status}, LivingLab: ${livinglabResponse.status}`);
        }
        
        const kitchenData = await kitchenResponse.json();
        const livinglabData = await livinglabResponse.json();
        
        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        taskPlanningData = {
          'Kitchen': {},
          'LivingLab': {}
        };
        
        if (kitchenTaskResponse.ok) {
          try {
            const kitchenTaskData = await kitchenTaskResponse.json();
            if (kitchenTaskData.task_planning && Array.isArray(kitchenTaskData.task_planning)) {
              kitchenTaskData.task_planning.forEach(task => {
                const predictionId = task.risk_prediction_id.toString();
                taskPlanningData['Kitchen'][predictionId] = task;
              });
            }
          } catch (e) {
            console.warn('Kitchenã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
          }
        } else {
          console.warn('Kitchenã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', CONFIG.TASK_PLANNING_FILES[0]);
        }
        
        if (livinglabTaskResponse.ok) {
          try {
            const livinglabTaskData = await livinglabTaskResponse.json();
            if (livinglabTaskData.task_planning && Array.isArray(livinglabTaskData.task_planning)) {
              livinglabTaskData.task_planning.forEach(task => {
                const predictionId = task.risk_prediction_id.toString();
                taskPlanningData['LivingLab'][predictionId] = task;
              });
            }
          } catch (e) {
            console.warn('LivingLabã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
          }
        } else {
          console.warn('LivingLabã‚¿ã‚¹ã‚¯è¨ˆç”»JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', CONFIG.TASK_PLANNING_FILES[1]);
        }
        
        console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿:', taskPlanningData);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆï¼ˆã‚­ãƒ¼ãŒé‡è¤‡ã—ãªã„å‰æã€ã¾ãŸã¯æ¥é ­è¾ã‚’ä»˜ã‘ã‚‹ï¼‰
        riskData = {};
        imagePaths = {};
        imageBasePaths = {};
        
        // Kitchenãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
        for (const [key, value] of Object.entries(kitchenData)) {
          riskData[key] = value;
          imageBasePaths[key] = 'Kitchen';
          // observationsé…åˆ—ã‹ã‚‰rgb_pathã‚’æŠ½å‡º
          if (value.observations && Array.isArray(value.observations)) {
            const excludedPaths = CONFIG.EXCLUDED_IMAGE_PATHS[key] || [];
            imagePaths[key] = value.observations
              .map(obs => obs.rgb_path)
              .filter(path => path && !excludedPaths.includes(path)); // null/undefinedã¨é™¤å¤–ãƒªã‚¹ãƒˆã‚’é™¤å¤–
          } else {
            imagePaths[key] = [];
          }
        }
        
        // LivingLabãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆï¼ˆã‚­ãƒ¼ãŒé‡è¤‡ã™ã‚‹å ´åˆã¯æ¥é ­è¾ã‚’ä»˜ã‘ã‚‹ï¼‰
        const maxKitchenKey = Math.max(...Object.keys(kitchenData).map(k => parseInt(k) || 0));
        for (const [key, value] of Object.entries(livinglabData)) {
          const newKey = (parseInt(key) + maxKitchenKey + 1).toString();
          riskData[newKey] = value;
          imageBasePaths[newKey] = 'LivingLab';
          // observationsé…åˆ—ã‹ã‚‰rgb_pathã‚’æŠ½å‡º
          if (value.observations && Array.isArray(value.observations)) {
            // å…ƒã®ã‚­ãƒ¼ã§é™¤å¤–ãƒªã‚¹ãƒˆã‚’ç¢ºèªï¼ˆLivingLabãƒ‡ãƒ¼ã‚¿ã®å ´åˆã‚‚å…ƒã®ã‚­ãƒ¼ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
            const excludedPaths = CONFIG.EXCLUDED_IMAGE_PATHS[key] || [];
            imagePaths[newKey] = value.observations
              .map(obs => obs.rgb_path)
              .filter(path => path && !excludedPaths.includes(path)); // null/undefinedã¨é™¤å¤–ãƒªã‚¹ãƒˆã‚’é™¤å¤–
          } else {
            imagePaths[newKey] = [];
          }
        }
        
        allImageIds = Object.keys(riskData).sort((a, b) => parseInt(a) - parseInt(b));
        // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãŒç„¡åŠ¹ã®å ´åˆã¯ã€å…¨ç”»åƒIDã‚’ä½¿ç”¨
        imageIds = allImageIds;
        
        // ç”»åƒãƒ‘ã‚¹ä¸€è¦§ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.log('=== ç”»åƒãƒ‘ã‚¹ä¸€è¦§ ===');
        for (const [imageId, paths] of Object.entries(imagePaths)) {
          const basePath = imageBasePaths[imageId];
          console.log(`ç”»åƒID ${imageId} (${basePath}):`, paths);
        }
        console.log('==================');
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('phase-intro').classList.remove('hidden');
        
        // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã®èª¬æ˜ã‚’è¡¨ç¤º
        if (CONFIG.ENABLE_GROUPING && allImageIds.length > 0) {
          const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
          const groupingInfoCard = document.getElementById('grouping-info-card');
          const groupingInfoText = document.getElementById('grouping-info-text');
          if (groupingInfoCard && groupingInfoText) {
            groupingInfoCard.style.display = 'block';
            groupingInfoText.innerHTML = `
              ãƒ»å…¨${allImageIds.length}æšã®ç”»åƒã‚’${CONFIG.GROUP_SIZE}æšãšã¤${totalGroups}ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†ã‘ã¦ã„ã¾ã™ã€‚<br>
              ãƒ»ãŠåå‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã„ãšã‚Œã‹ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚<br>
              ãƒ»ã‚ãªãŸã«ã¯<strong>ã‚°ãƒ«ãƒ¼ãƒ—ã®ã†ã¡1ã¤ï¼ˆ${CONFIG.GROUP_SIZE}æšã®ç”»åƒï¼‰</strong>ã®ã¿ã‚’è©•ä¾¡ã—ã¦ã„ãŸã ãã¾ã™ã€‚<br>
              ãƒ»ã“ã‚Œã«ã‚ˆã‚Šã€1äººã‚ãŸã‚Šã®è©•ä¾¡è² æ‹…ã‚’è»½æ¸›ã—ã¦ã„ã¾ã™ã€‚
            `;
          }
        }
        
        console.log(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${allImageIds.length}ä»¶ã®ç”»åƒã€å„ç”»åƒã«${AGENT_KEYS.length}ä»¶ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ`);
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loading').innerHTML = `
          <p style="color: #d93025;">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
          <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
          <p style="font-size: 12px; margin-top: 8px;">ç¢ºèªäº‹é …:</p>
          <ul style="font-size: 12px; margin-left: 20px; text-align: left; display: inline-block;">
            <li>JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„å ´æ‰€ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</li>
            <li>ã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãèµ·å‹•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</li>
            <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„</li>
          </ul>
        `;
      }
    }

    // ============================================
    // èª¿æŸ»é–‹å§‹
    // ============================================

    // èª¬æ˜ãƒšãƒ¼ã‚¸ã¸é€²ã‚€ï¼ˆIntroç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    function goToAgentExplanation() {
      document.getElementById('phase-intro').classList.add('hidden');
      document.getElementById('phase-agent-explanation').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // èª¬æ˜ãƒšãƒ¼ã‚¸ã‹ã‚‰Introã¸æˆ»ã‚‹
    function backToIntro() {
      document.getElementById('phase-agent-explanation').classList.add('hidden');
      document.getElementById('phase-intro').classList.remove('hidden');
    }

    // åå‰å…¥åŠ›ç”»é¢ã¸é€²ã‚€ï¼ˆAgentExplanationç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
    // â€»æ—¢å­˜ã®é–¢æ•°ã‚’æ›¸ãæ›ãˆã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã® goToNamePhase ã¯ãã®ã¾ã¾åˆ©ç”¨ã—ã¾ã™ã€‚
    //   ãŸã ã—ã€phase-intro ã‚’éš ã™å‡¦ç†ã ã‘ã§ãªã phase-agent-explanation ã‚’éš ã™å‡¦ç†ã‚‚å¿…è¦ã«ãªã‚Šã¾ã™ã€‚
    
    /* æ—¢å­˜ã® goToNamePhase é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ 
       ï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼‰
    */
    function goToNamePhase() {
      // 1. æœ€åˆã®èª¬æ˜ç”»é¢ã‚’éš ã™
      document.getElementById('phase-intro').classList.add('hidden');
      
      // 2. ã€ã“ã“ãŒé‡è¦ã€‘ã€ŒAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ï¼Ÿã€ç”»é¢ã‚‚éš ã™
      const agentExpl = document.getElementById('phase-agent-explanation');
      if (agentExpl) {
        agentExpl.classList.add('hidden');
      }
      
      // 3. åå‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
      document.getElementById('phase-name').classList.remove('hidden');
      
      // 4. ç”»é¢ã®ä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo(0, 0);
    }
    
    // function goToNamePhase() {
    //   document.getElementById('phase-intro').classList.add('hidden');
    //   document.getElementById('phase-name').classList.remove('hidden');
    // }
    
    function startSurvey() {
      const name = document.getElementById('participant-name').value.trim();
      if (!name) {
        alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      surveyData.participant.name = name;
      surveyData.participant.email = document.getElementById('participant-email').value.trim();
      surveyData.participant.startTime = new Date().toISOString();

      // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã®å‡¦ç†
      if (CONFIG.ENABLE_GROUPING && allImageIds.length > 0) {
        const groups = createImageGroups(allImageIds, CONFIG.GROUP_SIZE);
        const groupNumber = assignGroupToParticipant(name, groups.length);
        surveyData.assignedGroup = groupNumber;
        imageIds = groups[groupNumber] || [];
        console.log(`ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘: å…¨${allImageIds.length}æšã‚’${groups.length}ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã€ã‚°ãƒ«ãƒ¼ãƒ—${groupNumber + 1}ï¼ˆ${imageIds.length}æšï¼‰ã‚’å‰²ã‚Šå½“ã¦`);
      } else {
        // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãŒç„¡åŠ¹ã€ã¾ãŸã¯ç”»åƒãŒãªã„å ´åˆã¯å…¨ç”»åƒã‚’ä½¿ç”¨
        imageIds = allImageIds;
        surveyData.assignedGroup = null;
      }

      document.getElementById('phase-name').classList.add('hidden');
      document.getElementById('progress-container').classList.remove('hidden');
      document.getElementById('phase-validity').classList.remove('hidden');

      loadCurrentImage();
    }

    // ============================================
    // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠãƒ­ã‚¸ãƒƒã‚¯
    // ============================================
    
    /**
     * è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹
     */
    function getAgentsToDisplay(imageId) {
      const imageData = riskData[imageId];
      
      // åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const availableAgents = AGENT_KEYS.filter(key => {
        const agentData = imageData[key];
        if (!agentData) return false;
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        return !!reason;
      });

      switch (CONFIG.EVALUATION_MODE) {
        case 'ablation':
          // ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ï¼šæŒ‡å®šã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿
          return availableAgents.filter(key => CONFIG.ABLATION_AGENTS.includes(key));
        
        case 'random':
          // ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼šå‚åŠ è€…IDãƒ™ãƒ¼ã‚¹ã§ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠï¼ˆå†ç¾å¯èƒ½ï¼‰
          const participantId = surveyData.participant.name || 'default';
          const seed = hashString(participantId + imageId);
          const shuffled = shuffleArray([...availableAgents], seed);
          return shuffled.slice(0, CONFIG.RANDOM_AGENT_COUNT);
        
        case 'all':
        default:
          // å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¡¨ç¤º
          return availableAgents;
      }
    }

    /**
     * æ–‡å­—åˆ—ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆåŒã˜å‚åŠ è€…ãƒ»åŒã˜ç”»åƒã§åŒã˜çµæœã‚’è¿”ã™ï¼‰
     */
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      return Math.abs(hash);
    }

    /**
     * ã‚·ãƒ¼ãƒ‰ä»˜ãã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆå†ç¾å¯èƒ½ãªãƒ©ãƒ³ãƒ€ãƒ ï¼‰
     */
    function shuffleArray(array, seed) {
      const shuffled = [...array];
      let random = seed;
      for (let i = shuffled.length - 1; i > 0; i--) {
        random = (random * 9301 + 49297) % 233280;
        const j = Math.floor((random / 233280) * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // ============================================
    // ç”»åƒã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯
    // ============================================
    
    /**
     * ç”»åƒIDã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã™ã‚‹
     * @param {string[]} imageIds - ç”»åƒIDã®é…åˆ—
     * @param {number} groupSize - ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®ç”»åƒæ•°
     * @returns {string[][]} ã‚°ãƒ«ãƒ¼ãƒ—ã®é…åˆ—
     */
    function createImageGroups(imageIds, groupSize) {
      if (groupSize <= 0 || groupSize >= imageIds.length) {
        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚ºãŒç„¡åŠ¹ã€ã¾ãŸã¯ç”»åƒæ•°ä»¥ä¸‹ã®å ´åˆã¯ã€å…¨ç”»åƒã‚’1ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«
        return [imageIds];
      }
      
      const groups = [];
      for (let i = 0; i < imageIds.length; i += groupSize) {
        groups.push(imageIds.slice(i, i + groupSize));
      }
      return groups;
    }

    /**
     * å‚åŠ è€…ã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆé †ç•ªæ–¹å¼ï¼‰
     * @param {string} participantName - å‚åŠ è€…å
     * @param {number} totalGroups - ã‚°ãƒ«ãƒ¼ãƒ—ç·æ•°
     * @returns {number} å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ï¼ˆ0å§‹ã¾ã‚Šï¼‰
     */
    function assignGroupToParticipant(participantName, totalGroups) {
      if (totalGroups <= 0) return 0;
      // åå‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ã‚’æ±ºå®šï¼ˆé †ç•ªæ–¹å¼ï¼‰
      const hash = hashString(participantName);
      return hash % totalGroups;
    }

    // ============================================
    // ç”»åƒèª­ã¿è¾¼ã¿
    // ============================================
    
    function loadCurrentImage() {
      if (currentImageIndex >= imageIds.length) {
        // ãƒªã‚¹ã‚¯è©•ä¾¡ãŒå®Œäº†ã—ãŸã‚‰ã€ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã‚€
        console.log(`ãƒªã‚¹ã‚¯è©•ä¾¡å®Œäº†: ${currentImageIndex} / ${imageIds.length} æšè©•ä¾¡æ¸ˆã¿`);
        startTaskPlanningPhase();
        return;
      }

      const imageId = imageIds[currentImageIndex];
      const imageData = riskData[imageId];
      const container = document.getElementById('phase-validity');

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = ((currentImageIndex) / imageIds.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      let progressText = `${currentImageIndex + 1} / ${imageIds.length}`;
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        progressText = `ã‚°ãƒ«ãƒ¼ãƒ—${surveyData.assignedGroup + 1}: ${progressText}`;
      }
      document.getElementById('progress-text').textContent = progressText;

      // è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—
      const agentsToDisplay = getAgentsToDisplay(imageId);
      
      // ãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã‚’è¡¨ç¤º
      let modeInfo = '';
      if (CONFIG.EVALUATION_MODE === 'ablation') {
        modeInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">ã‚¢ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡ãƒ¢ãƒ¼ãƒ‰: ${agentsToDisplay.length}ä»¶ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¡¨ç¤º</p>`;
      } else if (CONFIG.EVALUATION_MODE === 'random') {
        modeInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰: ${agentsToDisplay.length}ä»¶ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¡¨ç¤º</p>`;
      }

      // ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’è¡¨ç¤º
      let groupInfo = '';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        groupInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">ã‚°ãƒ«ãƒ¼ãƒ—${surveyData.assignedGroup + 1}/${totalGroups}ï¼ˆå…¨${allImageIds.length}æšä¸­${imageIds.length}æšã‚’è©•ä¾¡ï¼‰</p>`;
      }

      // ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆæœ€åˆã®ç”»åƒãƒ‘ã‚¹ã‚’ä½¿ç”¨ï¼‰
      const paths = imagePaths[imageId] || [];
      const basePath = imageBasePaths[imageId] || 'Kitchen';
      const firstImagePath = paths.length > 0 ? paths[0] : null;
      const imageSrc = firstImagePath 
        ? `${CONFIG.IMAGE_BASE_PATHS[basePath]}${firstImagePath}`
        : `https://via.placeholder.com/600x400?text=Image+${imageId}`;
      const imageLabel = `${basePath} - ç”»åƒ ${imageId}${paths.length > 1 ? ` (${paths.length}æšã®ç”»åƒã‹ã‚‰1æšç›®ã‚’è¡¨ç¤º)` : ''}`;

      // HTMLã‚’ç”Ÿæˆ
      let html = `
        <div class="section-header">
          <h2>ç”»åƒ ${imageId} ã®è©•ä¾¡</h2>
          <p>${currentImageIndex + 1} / ${imageIds.length} æšç›®</p>
          ${groupInfo}
          ${modeInfo}
        </div>

        <div class="image-section">
          <img src="${imageSrc}" alt="ç”»åƒ ${imageId}" onerror="this.src='https://via.placeholder.com/600x400?text=Image+${imageId}'">
          <div class="image-label">${imageLabel}</div>
          ${paths.length > 1 ? `<div style="font-size: 12px; color: #5f6368; margin-top: 4px;">ã“ã®ç”»åƒIDã«ã¯${paths.length}æšã®ç”»åƒãŒã‚ã‚Šã¾ã™ï¼ˆ1æšç›®ã‚’è¡¨ç¤ºï¼‰</div>` : ''}
        </div>
      `;

      // é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã®è©•ä¾¡ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        // ãƒªã‚¹ã‚¯ç†ç”±ã‚’å–å¾—ï¼ˆupdated_reason_01ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆï¼‰
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        const judge = agentData.updated_judge_01 || agentData.risk_judge;

        if (!reason) continue;

        const displayName = AGENT_DISPLAY_NAMES[agentKey] || agentKey;
        const badgeClass = getBadgeClass(judge);

        html += `
          <div class="agent-card">
            <div class="agent-header">
              <span class="agent-badge">${displayName}</span>
              <span class="risk-badge ${badgeClass}">${getRiskLabel(judge)}</span>
            </div>
            <div class="agent-reason">${reason}</div>
            
            <div class="rating-group" id="agree-group-${imageId}-${agentKey}">
              <div class="rating-label">
                1. ç›´æ„Ÿçš„ç´å¾—æ„Ÿ<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('agree-help-${imageId}-${agentKey}')">è©•ä¾¡åŸºæº–ã«ã¤ã„ã¦è©³ã—ãè¦‹ã‚‹</span>
              </div>
              <div class="help-content" id="agree-help-${imageId}-${agentKey}">
                <strong>è³ªå•ï¼š</strong>ã‚·ã‚¹ãƒ†ãƒ ãŒä¸‹ã—ãŸãƒªã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªï¼ˆç·Šæ€¥é‡å¤§ã€œå®‰å…¨ï¼‰ã¯ã€ã‚ãªãŸã®ç›´æ„Ÿã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ<br>
                <strong>ç›®çš„ï¼š</strong>æœ€çµ‚çš„ãªã€Œåˆ¤å®šçµæœã€ã®æ­£ã—ã•ã‚’æ¸¬ã‚‹ã€‚<br><br>
                <strong>è©•ä¾¡åŸºæº–ï¼š</strong>
                <ul>
                  <li><strong>5 - éå¸¸ã«ç´å¾—ã§ãã‚‹ï¼ˆè‡ªåˆ†ã®æ„Ÿè¦šã¨åŒã˜ï¼‰</strong>ï¼šè‡ªåˆ†ãŒåˆ¤æ–­ã™ã‚‹ã¨ãã‚‚ã€ã»ã¼åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹</li>
                  <li><strong>4 - æ¦‚ã­ç´å¾—ã§ãã‚‹</strong>ï¼šã ã„ãŸã„åŒæ„ã§ãã‚‹ãŒã€å°‘ã—æ°—ã«ãªã‚‹ç‚¹ãŒã‚ã‚‹</li>
                  <li><strong>3 - ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„</strong>ï¼šè‰¯ã„ã¨ã‚‚æ‚ªã„ã¨ã‚‚åˆ¤æ–­ã—ã¥ã‚‰ã„</li>
                  <li><strong>2 - ã‚ã¾ã‚Šç´å¾—ã§ããªã„</strong>ï¼šè‡ªåˆ†ã®æ„Ÿè¦šã¨ã¯å°‘ã—é•ã†</li>
                  <li><strong>1 - å…¨ãç´å¾—ã§ããªã„ï¼ˆçš„å¤–ã‚Œï¼‰</strong>ï¼šè‡ªåˆ†ã®æ„Ÿè¦šã¨ã¯å…¨ãé•ã†ï¼å±é™ºã®æ‰ãˆæ–¹ãŒã‚ºãƒ¬ã¦ã„ã‚‹</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">ã‚·ã‚¹ãƒ†ãƒ ãŒä¸‹ã—ãŸãƒªã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªã¯ã€ã‚ãªãŸã®ç›´æ„Ÿã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ</p>
              <div class="rating-options">
                ${AGREE_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="agree-${imageId}-${agentKey}" id="agree-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="agree-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">ã“ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„</div>
            </div>

            ${CONFIG.SIMPLIFY_THOUGHT ? '' : `
            <div class="rating-group" id="thought-group-${imageId}-${agentKey}">
              <div class="rating-label">
                2. æ ¹æ‹ ã®å¦¥å½“æ€§ãƒ»å¤šè§’æ€§<span class="required">*</span>
                <span class="help-toggle" onclick="toggleHelp('thought-help-${imageId}-${agentKey}')">è©•ä¾¡åŸºæº–ã«ã¤ã„ã¦è©³ã—ãè¦‹ã‚‹</span>
              </div>
              <div class="help-content" id="thought-help-${imageId}-${agentKey}">
                <strong>è³ªå•ï¼š</strong>ãã®ãƒªã‚¹ã‚¯ã¨åˆ¤æ–­ã—ãŸã€Œç†ç”±ã€ã®å†…å®¹ã¯ã€éä¸è¶³ãªãé©åˆ‡ã§ã™ã‹ï¼Ÿ<br>
                <strong>ç›®çš„ï¼š</strong>æ¨è«–ãƒ—ãƒ­ã‚»ã‚¹ã®ã€Œè³ªã€ã‚’æ¸¬ã‚‹ã€‚ã€Œè€ƒãˆã™ãï¼ˆéå‰°ï¼‰ã€ã¨ã€Œæ ¹æ‹ ä¸è¶³ï¼ˆéå°ï¼‰ã€ã‚’åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«ã§è©•ä¾¡ã§ãã¾ã™ã€‚<br><br>
                <strong>è©•ä¾¡åŸºæº–ï¼š</strong>
                <ul>
                  <li><strong>5 - éå‰°ã«åå¿œã—ã™ãã¦ã„ã‚‹</strong>ï¼šéå¸¸ã«ä½ã„ç¢ºç‡ã®ãƒªã‚¹ã‚¯ã‚’æ‡¸å¿µã—ã™ãã¦ã„ã‚‹</li>
                  <li><strong>4 - ã‚„ã‚„è€ƒãˆã™ãã§ã‚ã‚‹</strong>ï¼šè«–ç†ã¯é€šã£ã¦ã„ã‚‹ãŒã€ãã“ã¾ã§å¿ƒé…ã—ãªãã¦ã‚‚è‰¯ã„å†…å®¹ã‚’å«ã‚€</li>
                  <li><strong>3 - é©åˆ‡ã‹ã¤å¤šè§’çš„ã§ã‚ã‚‹</strong>ï¼šæ§˜ã€…ãªæƒ…å ±ãŒãƒãƒ©ãƒ³ã‚¹ã‚ˆãè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹</li>
                  <li><strong>2 - æ ¹æ‹ ãŒä¸è¶³ã—ã¦ã„ã‚‹</strong>ï¼šç›´æ„Ÿçš„ã ãŒã€ãªãœãã†ãªã‚‹ã‹ã®èª¬æ˜ãŒè¶³ã‚Šãªã„</li>
                  <li><strong>1 - æ ¹æ‹ ãŒä¸é©åˆ‡ãƒ»ç„¡é–¢ä¿‚</strong>ï¼šå…¨ãé–¢ä¿‚ãªã„ã“ã¨ã«è¨€åŠã—ã¦ã„ã‚‹</li>
                </ul>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">ãã®ãƒªã‚¹ã‚¯ã¨åˆ¤æ–­ã—ãŸã€Œç†ç”±ã€ã®å†…å®¹ã¯ã€éä¸è¶³ãªãé©åˆ‡ã§ã™ã‹ï¼Ÿ</p>
              <div class="rating-options">
                ${THOUGHT_CHOICES.map(choice => `
                  <div class="rating-option">
                    <input type="radio" name="thought-${imageId}-${agentKey}" id="thought-${imageId}-${agentKey}-${choice.value}" value="${choice.value}" required onchange="clearError(this)">
                    <label for="thought-${imageId}-${agentKey}-${choice.value}">${choice.label}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">ã“ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„</div>
            </div>
            `}
          </div>
        `;
      }

      html += `
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevImage()" ${currentImageIndex === 0 ? 'disabled style="opacity:0.5"' : ''}>æˆ»ã‚‹</button>
          <button class="btn btn-primary" onclick="nextImage()">
            ${currentImageIndex === imageIds.length - 1 ? 'é€ä¿¡' : 'æ¬¡ã¸'}
          </button>
        </div>
      `;

      container.innerHTML = html;
      window.scrollTo(0, 0);
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
      skipValidationClickCount = 0;
      skipValidationEnabled = false;
      
      // éš ã—ã‚³ãƒãƒ³ãƒ‰: ãƒšãƒ¼ã‚¸ã®ç©ºã„ã¦ã„ã‚‹å ´æ‰€ã‚’5å›ä»¥ä¸Šã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—
      const containerElement = document.getElementById('phase-validity');
      if (containerElement) {
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const newContainerElement = containerElement.cloneNode(true);
        containerElement.parentNode.replaceChild(newContainerElement, containerElement);
        
        newContainerElement.addEventListener('click', function(e) {
          // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ï¼ˆinput, button, labelãªã©ï¼‰ä»¥å¤–ã®ã‚¯ãƒªãƒƒã‚¯ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
          const isFormElement = e.target.tagName === 'INPUT' || 
                               e.target.tagName === 'BUTTON' || 
                               e.target.tagName === 'LABEL' ||
                               e.target.closest('.rating-option') ||
                               e.target.closest('.btn') ||
                               e.target.closest('.help-toggle') ||
                               e.target.closest('.help-content');
          
          if (!isFormElement) {
            skipValidationClickCount++;
            if (skipValidationClickCount >= 5 && !skipValidationEnabled) {
              skipValidationEnabled = true;
              console.log('éš ã—ã‚³ãƒãƒ³ãƒ‰æœ‰åŠ¹åŒ–: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é€²ã‚ã¾ã™');
              // è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
              newContainerElement.style.border = '3px solid #673ab7';
              newContainerElement.style.transition = 'border 0.3s';
              setTimeout(() => {
                newContainerElement.style.border = '';
              }, 1000);
            }
          }
        });
      }
    }

    // ============================================
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    // ============================================
    
    function nextImage() {
      // éš ã—ã‚³ãƒãƒ³ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (skipValidationEnabled) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¿å­˜
        saveCurrentResponses(false);
      } else {
        // é€šå¸¸é€šã‚Šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ã‚Šã§ä¿å­˜
        if (!saveCurrentResponses()) {
          return;
        }
      }

      currentImageIndex++;
      loadCurrentImage();
    }

    function prevImage() {
      if (currentImageIndex > 0) {
        saveCurrentResponses(false); // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ä¿å­˜
        currentImageIndex--;
        loadCurrentImage();
        restoreResponses();
      }
    }

    function saveCurrentResponses(validate = true) {
      const imageId = imageIds[currentImageIndex];
      const imageData = riskData[imageId];
      const assessments = {};
      const unanswered = [];

      // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
      const agentsToDisplay = getAgentsToDisplay(imageId);

      // ã¾ãšå…¨ã¦ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.rating-group.error').forEach(el => el.classList.remove('error'));

      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        if (!reason) continue;

        const agreeInput = document.querySelector(`input[name="agree-${imageId}-${agentKey}"]:checked`);
        const thoughtInput = CONFIG.SIMPLIFY_THOUGHT ? null : document.querySelector(`input[name="thought-${imageId}-${agentKey}"]:checked`);

        if (validate) {
          if (!agreeInput) {
            unanswered.push({ type: 'agree', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
          if (!CONFIG.SIMPLIFY_THOUGHT && !thoughtInput) {
            unanswered.push({ type: 'thought', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
        }

        assessments[agentKey] = {
          displayName: AGENT_DISPLAY_NAMES[agentKey] || agentKey,
          judge: agentData.updated_judge_01 || agentData.risk_judge,
          agreeRating: agreeInput ? parseInt(agreeInput.value) : null,
          thoughtRating: thoughtInput ? parseInt(thoughtInput.value) : null
        };
      }

      // æœªå›ç­”ãŒã‚ã‚‹å ´åˆ
      if (validate && unanswered.length > 0) {
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        unanswered.forEach(item => {
          const groupId = `${item.type}-group-${imageId}-${item.agentKey}`;
          const group = document.getElementById(groupId);
          if (group) {
            group.classList.add('error');
          }
        });

        // æœ€åˆã®æœªå›ç­”ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        const firstError = unanswered[0];
        const firstGroupId = `${firstError.type}-group-${imageId}-${firstError.agentKey}`;
        const firstGroup = document.getElementById(firstGroupId);
        if (firstGroup) {
          firstGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        showUnansweredAlert(unanswered.length);
        return false;
      }

      // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã¾ãŸã¯è¿½åŠ 
      const existingIndex = surveyData.validityResults.findIndex(r => r.imageId === imageId);
      const resultData = { imageId, room: 'Kitchen', assessments };
      
      if (existingIndex >= 0) {
        surveyData.validityResults[existingIndex] = resultData;
      } else {
        surveyData.validityResults.push(resultData);
      }

      return true;
    }

    function restoreResponses() {
      const imageId = imageIds[currentImageIndex];
      const existingResult = surveyData.validityResults.find(r => r.imageId === imageId);
      
      if (existingResult) {
        for (const [agentKey, assessment] of Object.entries(existingResult.assessments)) {
          if (assessment.agreeRating) {
            const agreeInput = document.getElementById(`agree-${imageId}-${agentKey}-${assessment.agreeRating}`);
            if (agreeInput) agreeInput.checked = true;
          }
          if (assessment.thoughtRating) {
            const thoughtInput = document.getElementById(`thought-${imageId}-${agentKey}-${assessment.thoughtRating}`);
            if (thoughtInput) thoughtInput.checked = true;
          }
        }
      }
    }

    // ============================================
    // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡
    // ============================================
    
    function startTaskPlanningPhase() {
      console.log('=== ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹ ===');
      console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãƒ‡ãƒ¼ã‚¿:', taskPlanningData);
      console.log('è©•ä¾¡å¯¾è±¡ç”»åƒID:', imageIds);
      console.log('ç”»åƒãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:', imageBasePaths);
      
      // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒå­˜åœ¨ã™ã‚‹ç”»åƒIDã®ã¿ã‚’æŠ½å‡º
      taskPlanningImageIds = imageIds.filter(imageId => {
        const basePath = imageBasePaths[imageId];
        // LivingLabã®å ´åˆã¯å…ƒã®prediction_idã‚’è¨ˆç®—
        let predictionId = imageId;
        if (basePath === 'LivingLab') {
          const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
          predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
        }
        const hasTaskPlan = taskPlanningData[basePath] && taskPlanningData[basePath][predictionId];
        console.log(`ç”»åƒID ${imageId} (${basePath}, predictionId: ${predictionId}): ã‚¿ã‚¹ã‚¯è¨ˆç”»${hasTaskPlan ? 'ã‚ã‚Š' : 'ãªã—'}`);
        return hasTaskPlan;
      });
      
      console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡å¯¾è±¡ç”»åƒID:', taskPlanningImageIds);
      
      if (taskPlanningImageIds.length === 0) {
        // ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒãªã„å ´åˆã¯å®Œäº†ãƒšãƒ¼ã‚¸ã¸
        console.log('ã‚¿ã‚¹ã‚¯è¨ˆç”»ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å®Œäº†ãƒšãƒ¼ã‚¸ã¸é·ç§»ã—ã¾ã™');
        finishSurvey();
        return;
      }
      
      console.log(`ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ•ã‚§ãƒ¼ã‚ºã«é·ç§»ã—ã¾ã™ï¼ˆ${taskPlanningImageIds.length}æšã®ç”»åƒï¼‰`);
      currentTaskPlanningIndex = 0;
      document.getElementById('phase-validity').classList.add('hidden');
      document.getElementById('phase-task-planning').classList.remove('hidden');
      loadCurrentTaskPlanning();
    }
    
    function loadCurrentTaskPlanning() {
      if (currentTaskPlanningIndex >= taskPlanningImageIds.length) {
        finishSurvey();
        return;
      }
      
      const imageId = taskPlanningImageIds[currentTaskPlanningIndex];
      const imageData = riskData[imageId];
      const basePath = imageBasePaths[imageId];
      const container = document.getElementById('phase-task-planning');
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = ((currentTaskPlanningIndex) / taskPlanningImageIds.length) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
      let progressText = `ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡: ${currentTaskPlanningIndex + 1} / ${taskPlanningImageIds.length}`;
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        progressText = `ã‚°ãƒ«ãƒ¼ãƒ—${surveyData.assignedGroup + 1}: ${progressText}`;
      }
      document.getElementById('progress-text').textContent = progressText;
      
      // LivingLabã®å ´åˆã¯å…ƒã®prediction_idã‚’è¨ˆç®—
      let predictionId = imageId;
      if (basePath === 'LivingLab') {
        const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
        predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
      }
      
      const taskPlan = taskPlanningData[basePath][predictionId];
      if (!taskPlan) {
        currentTaskPlanningIndex++;
        loadCurrentTaskPlanning();
        return;
      }
      
      // è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—ï¼ˆãƒªã‚¹ã‚¯è©•ä¾¡ã¨åŒã˜ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
      const agentsToDisplay = getAgentsToDisplay(imageId);
      
      // ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’è¡¨ç¤º
      let groupInfo = '';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        groupInfo = `<p style="font-size: 12px; opacity: 0.8; margin-top: 4px;">ã‚°ãƒ«ãƒ¼ãƒ—${surveyData.assignedGroup + 1}/${totalGroups}ï¼ˆå…¨${allImageIds.length}æšä¸­${taskPlanningImageIds.length}æšã‚’è©•ä¾¡ï¼‰</p>`;
      }
      
      // ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—
      const paths = imagePaths[imageId] || [];
      const firstImagePath = paths.length > 0 ? paths[0] : null;
      const imageSrc = firstImagePath 
        ? `${CONFIG.IMAGE_BASE_PATHS[basePath]}${firstImagePath}`
        : `https://via.placeholder.com/600x400?text=Image+${imageId}`;
      const imageLabel = `${basePath} - ç”»åƒ ${imageId}${paths.length > 1 ? ` (${paths.length}æšã®ç”»åƒã‹ã‚‰1æšç›®ã‚’è¡¨ç¤º)` : ''}`;
      
      // HTMLã‚’ç”Ÿæˆ
      let html = `
        <div class="section-header">
          <h2>ç”»åƒ ${imageId} ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡</h2>
          <p>${currentTaskPlanningIndex + 1} / ${taskPlanningImageIds.length} æšç›®</p>
          ${groupInfo}
        </div>

        <div class="image-section">
          <img src="${imageSrc}" alt="ç”»åƒ ${imageId}" onerror="this.src='https://via.placeholder.com/600x400?text=Image+${imageId}'">
          <div class="image-label">${imageLabel}</div>
          ${paths.length > 1 ? `<div style="font-size: 12px; color: #5f6368; margin-top: 4px;">ã“ã®ç”»åƒIDã«ã¯${paths.length}æšã®ç”»åƒãŒã‚ã‚Šã¾ã™ï¼ˆ1æšç›®ã‚’è¡¨ç¤ºï¼‰</div>` : ''}
        </div>
      `;

      // å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;

        // ãƒªã‚¹ã‚¯ç†ç”±ã¨åˆ¤æ–­ã‚’å–å¾—
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        const judge = agentData.updated_judge_01 || agentData.risk_judge;

        if (!reason) continue;

        const displayName = AGENT_DISPLAY_NAMES[agentKey] || agentKey;
        const badgeClass = getBadgeClass(judge);

        html += `
          <div class="agent-card">
            <div class="agent-header">
              <span class="agent-badge">${displayName}</span>
              <span class="risk-badge ${badgeClass}">${getRiskLabel(judge)}</span>
            </div>
            <div class="agent-reason">${reason}</div>
            
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-top: 16px;">
              <p style="font-weight: 500; margin-bottom: 8px;"><strong>ã‚¿ã‚¹ã‚¯è¨ˆç”»:</strong></p>
              <p style="margin-bottom: 12px; color: #5f6368;">${taskPlan.task || ''}</p>
              ${taskPlan.action ? `
                <p style="font-weight: 500; margin-bottom: 8px;"><strong>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong></p>
                <pre style="background: white; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 13px; white-space: pre-wrap; margin-bottom: 0;">${JSON.stringify(taskPlan.action, null, 2)}</pre>
              ` : ''}
            </div>
            
            <div class="rating-group" id="task-validity-group-${imageId}-${agentKey}">
              <div class="rating-label">
                1. ã‚¿ã‚¹ã‚¯è¨ˆç”»ã®å¦¥å½“æ€§<span class="required">*</span>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">ã“ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»ã¯ã€ãƒªã‚¹ã‚¯ã«å¯¾ã—ã¦é©åˆ‡ãªå¯¾å‡¦æ–¹æ³•ã§ã™ã‹ï¼Ÿ</p>
              <div class="rating-options">
                ${[5, 4, 3, 2, 1].map(value => `
                  <div class="rating-option">
                    <input type="radio" name="task-validity-${imageId}-${agentKey}" id="task-validity-${imageId}-${agentKey}-${value}" value="${value}" required onchange="clearError(this)">
                    <label for="task-validity-${imageId}-${agentKey}-${value}">${value === 5 ? 'éå¸¸ã«å¦¥å½“' : value === 4 ? 'æ¦‚ã­å¦¥å½“' : value === 3 ? 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' : value === 2 ? 'ã‚ã¾ã‚Šå¦¥å½“ã§ãªã„' : 'å…¨ãå¦¥å½“ã§ãªã„'}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">ã“ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„</div>
            </div>

            <div class="rating-group" id="task-feasibility-group-${imageId}-${agentKey}">
              <div class="rating-label">
                2. ã‚¿ã‚¹ã‚¯è¨ˆç”»ã®å®Ÿè¡Œå¯èƒ½æ€§<span class="required">*</span>
              </div>
              <p style="font-size: 12px; color: #5f6368; margin-bottom: 8px;">ã“ã®ã‚¿ã‚¹ã‚¯è¨ˆç”»ã¯ã€å®Ÿéš›ã«å®Ÿè¡Œå¯èƒ½ã§ã™ã‹ï¼Ÿ</p>
              <div class="rating-options">
                ${[5, 4, 3, 2, 1].map(value => `
                  <div class="rating-option">
                    <input type="radio" name="task-feasibility-${imageId}-${agentKey}" id="task-feasibility-${imageId}-${agentKey}-${value}" value="${value}" required onchange="clearError(this)">
                    <label for="task-feasibility-${imageId}-${agentKey}-${value}">${value === 5 ? 'éå¸¸ã«å®Ÿè¡Œå¯èƒ½' : value === 4 ? 'æ¦‚ã­å®Ÿè¡Œå¯èƒ½' : value === 3 ? 'ã©ã¡ã‚‰ã¨ã‚‚ã„ãˆãªã„' : value === 2 ? 'ã‚ã¾ã‚Šå®Ÿè¡Œå¯èƒ½ã§ãªã„' : 'å…¨ãå®Ÿè¡Œä¸å¯èƒ½'}</label>
                  </div>
                `).join('')}
              </div>
              <div class="error-message">ã“ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„</div>
            </div>
          </div>
        `;
      }
      
      html += `
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevTaskPlanning()" ${currentTaskPlanningIndex === 0 ? 'disabled' : ''}>å‰ã¸</button>
          <button class="btn btn-primary" onclick="nextTaskPlanning()">${currentTaskPlanningIndex >= taskPlanningImageIds.length - 1 ? 'å®Œäº†' : 'æ¬¡ã¸'}</button>
        </div>
      `;
      
      container.innerHTML = html;
      
      // æ—¢å­˜ã®å›ç­”ã‚’å¾©å…ƒ
      restoreTaskPlanningResponses(imageId);
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸Šã«
      window.scrollTo(0, 0);
    }
    
    function saveTaskPlanningResponses(validate = true) {
      const imageId = taskPlanningImageIds[currentTaskPlanningIndex];
      const imageData = riskData[imageId];
      const basePath = imageBasePaths[imageId];
      
      let predictionId = imageId;
      if (basePath === 'LivingLab') {
        const maxKitchenKey = Math.max(...Object.keys(riskData).filter(k => imageBasePaths[k] === 'Kitchen').map(k => parseInt(k) || 0));
        predictionId = (parseInt(imageId) - maxKitchenKey - 1).toString();
      }
      
      const taskPlan = taskPlanningData[basePath][predictionId];
      if (!taskPlan) return true;
      
      // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
      const agentsToDisplay = getAgentsToDisplay(imageId);
      const assessments = {};
      const unanswered = [];
      
      // ã¾ãšå…¨ã¦ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.rating-group.error').forEach(el => el.classList.remove('error'));
      
      for (const agentKey of agentsToDisplay) {
        const agentData = imageData[agentKey];
        if (!agentData) continue;
        
        const reason = agentData.updated_reason_01 || agentData.risk_reason;
        if (!reason) continue;
        
        const validityInput = document.querySelector(`input[name="task-validity-${imageId}-${agentKey}"]:checked`);
        const feasibilityInput = document.querySelector(`input[name="task-feasibility-${imageId}-${agentKey}"]:checked`);
        
        if (validate) {
          if (!validityInput) {
            unanswered.push({ type: 'validity', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
          if (!feasibilityInput) {
            unanswered.push({ type: 'feasibility', agentKey, displayName: AGENT_DISPLAY_NAMES[agentKey] });
          }
        }
        
        assessments[agentKey] = {
          displayName: AGENT_DISPLAY_NAMES[agentKey] || agentKey,
          validityRating: validityInput ? parseInt(validityInput.value) : null,
          feasibilityRating: feasibilityInput ? parseInt(feasibilityInput.value) : null
        };
      }
      
      // æœªå›ç­”ãŒã‚ã‚‹å ´åˆ
      if (validate && unanswered.length > 0) {
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        unanswered.forEach(item => {
          const groupId = `task-${item.type}-group-${imageId}-${item.agentKey}`;
          const group = document.getElementById(groupId);
          if (group) {
            group.classList.add('error');
          }
        });
        
        // æœ€åˆã®æœªå›ç­”ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        const firstError = unanswered[0];
        const firstGroupId = `task-${firstError.type}-group-${imageId}-${firstError.agentKey}`;
        const firstGroup = document.getElementById(firstGroupId);
        if (firstGroup) {
          firstGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        showUnansweredAlert(unanswered.length);
        return false;
      }
      
      // æ—¢å­˜ã®çµæœã‚’æ¢ã™
      const existingIndex = surveyData.taskPlanningResults.findIndex(r => r.imageId === imageId);
      const result = {
        imageId: imageId,
        room: basePath,
        riskPredictionId: predictionId,
        task: taskPlan.task,
        action: taskPlan.action,
        assessments: assessments
      };
      
      if (existingIndex >= 0) {
        surveyData.taskPlanningResults[existingIndex] = result;
      } else {
        surveyData.taskPlanningResults.push(result);
      }
      
      return true;
    }
    
    function restoreTaskPlanningResponses(imageId) {
      const existingResult = surveyData.taskPlanningResults.find(r => r.imageId === imageId);
      
      if (existingResult && existingResult.assessments) {
        for (const [agentKey, assessment] of Object.entries(existingResult.assessments)) {
          if (assessment.validityRating) {
            const validityInput = document.getElementById(`task-validity-${imageId}-${agentKey}-${assessment.validityRating}`);
            if (validityInput) validityInput.checked = true;
          }
          if (assessment.feasibilityRating) {
            const feasibilityInput = document.getElementById(`task-feasibility-${imageId}-${agentKey}-${assessment.feasibilityRating}`);
            if (feasibilityInput) feasibilityInput.checked = true;
          }
        }
      }
    }
    
    function nextTaskPlanning() {
      if (!saveTaskPlanningResponses()) {
        return;
      }
      currentTaskPlanningIndex++;
      loadCurrentTaskPlanning();
    }
    
    function prevTaskPlanning() {
      if (currentTaskPlanningIndex > 0) {
        saveTaskPlanningResponses(false);
        currentTaskPlanningIndex--;
        loadCurrentTaskPlanning();
      }
    }

    // ============================================
    // å®Œäº†
    // ============================================
    
    function finishSurvey() {
      surveyData.participant.endTime = new Date().toISOString();
      
      document.getElementById('progress-container').classList.add('hidden');
      document.getElementById('phase-validity').classList.add('hidden');
      document.getElementById('phase-task-planning').classList.add('hidden');
      document.getElementById('phase-complete').classList.remove('hidden');
    }

    // ============================================
    // Google Spreadsheeté€ä¿¡
    // ============================================
    
    async function sendToSpreadsheet() {
      const endpoint = CONFIG.SPREADSHEET_ENDPOINT;
      
      if (!endpoint || endpoint.trim() === '') {
        showSpreadsheetStatus('ã‚¨ãƒ©ãƒ¼: Google Spreadsheetã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CONFIG.SPREADSHEET_ENDPOINTã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-send-spreadsheet');
      const statusDiv = document.getElementById('spreadsheet-status');
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      btn.disabled = true;
      btn.textContent = 'é€ä¿¡ä¸­...';
      statusDiv.style.display = 'block';
      statusDiv.style.backgroundColor = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.textContent = 'Google Spreadsheetã«é€ä¿¡ä¸­...';
      
      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚’Google Apps ScriptãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«å¤‰æ›
        const validityData = [];
        for (const result of surveyData.validityResults) {
          for (const [agentKey, assessment] of Object.entries(result.assessments)) {
            if (assessment.agreeRating !== null || assessment.thoughtRating !== null) {
              validityData.push({
                imageId: result.imageId,
                room: result.room,
                agentId: agentKey,
                judge: assessment.judge || '',
                agreeRating: assessment.agreeRating || null,
                thoughtRating: assessment.thoughtRating || null
              });
            }
          }
        }
        
        // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã”ã¨ï¼‰
        const taskPlanningDataForSpreadsheet = [];
        for (const result of surveyData.taskPlanningResults) {
          if (result.assessments) {
            for (const [agentKey, assessment] of Object.entries(result.assessments)) {
              taskPlanningDataForSpreadsheet.push({
                imageId: result.imageId,
                room: result.room,
                riskPredictionId: result.riskPredictionId,
                agentId: agentKey,
                validityRating: assessment.validityRating || null,
                feasibilityRating: assessment.feasibilityRating || null
              });
            }
          }
        }
        
        const payload = {
          participant: {
            name: surveyData.participant.name,
            email: surveyData.participant.email || '',
            startTime: surveyData.participant.startTime,
            endTime: surveyData.participant.endTime
          },
          coverage: [], // Coverageè©•ä¾¡ã¯ç¾åœ¨å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚ç©ºé…åˆ—
          validity: validityData,
          taskPlanning: taskPlanningDataForSpreadsheet
        };
        
        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
        console.log('é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:', payload);
        console.log('Validityãƒ‡ãƒ¼ã‚¿ä»¶æ•°:', validityData.length);
        console.log('ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:', endpoint);
        
        // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        // Google Apps Scriptã¯CORSã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãŸã‚ã€é€šå¸¸ã®fetchã‚’ä½¿ç”¨
        let response;
        try {
          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });
        } catch (fetchError) {
          // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã€no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œ
          console.warn('CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚no-corsãƒ¢ãƒ¼ãƒ‰ã§å†è©¦è¡Œã—ã¾ã™ã€‚', fetchError);
          console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(payload));
          
          try {
            await fetch(endpoint, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload)
            });
            // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã§ããªã„ãŸã‚ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸã¨ã¿ãªã™
            await new Promise(resolve => setTimeout(resolve, 2000));
            statusDiv.style.backgroundColor = '#fff3cd';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = `âš ï¸ Google Spreadsheetã«é€ä¿¡ã—ã¾ã—ãŸï¼ˆno-corsãƒ¢ãƒ¼ãƒ‰ï¼‰<br><small>é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${validityData.length}ä»¶ã®Validityè©•ä¾¡<br>ãƒ‡ãƒ¼ã‚¿ã¯ã€ŒValidityè©•ä¾¡ã€ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚Spreadsheetã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Google Apps Scriptã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>`;
            btn.textContent = 'âš ï¸ é€ä¿¡å®Œäº†ï¼ˆç¢ºèªè¦ï¼‰';
          } catch (noCorsError) {
            console.error('no-corsãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã‚¨ãƒ©ãƒ¼:', noCorsError);
            throw new Error(`é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${noCorsError.message}`);
          }
          return;
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status, response.statusText);
        
        if (response.ok) {
          const result = await response.json();
          console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿:', result);
          
          if (result.success) {
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            statusDiv.style.backgroundColor = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `âœ… Google Spreadsheetã«æ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼<br><small>å‚åŠ è€…: ${result.participant || surveyData.participant.name}<br>Validityè©•ä¾¡: ${result.validityCount || validityData.length}ä»¶<br>ãƒ‡ãƒ¼ã‚¿ã¯ã€ŒValidityè©•ä¾¡ã€ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</small>`;
            btn.textContent = 'âœ… é€ä¿¡å®Œäº†';
          } else {
            throw new Error(result.error || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          const errorText = await response.text();
          console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
          throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorText}`);
        }
        
      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}<br><small>é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${validityData.length}ä»¶ã®Validityè©•ä¾¡<br>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${endpoint}<br><br>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:<br>1. Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>3. Google Apps Scriptã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„<br>4. CSVã¾ãŸã¯JSONã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æ‰‹å‹•ã§Spreadsheetã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</small>`;
        btn.disabled = false;
        btn.textContent = 'ğŸ“Š Google Spreadsheetã«é€ä¿¡';
      }
    }
    
    function showSpreadsheetStatus(message, type = 'info') {
      const statusDiv = document.getElementById('spreadsheet-status');
      statusDiv.style.display = 'block';
      
      if (type === 'error') {
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';
      } else if (type === 'success') {
        statusDiv.style.backgroundColor = '#d4edda';
        statusDiv.style.color = '#155724';
      } else {
        statusDiv.style.backgroundColor = '#fff3cd';
        statusDiv.style.color = '#856404';
      }
      
      statusDiv.textContent = message;
    }

    // ============================================
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    // ============================================
    
    function downloadJSON() {
      const dataStr = JSON.stringify(surveyData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `risk_evaluation_${surveyData.participant.name}_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadImagePaths() {
      // ã™ã¹ã¦ã®ç•ªå·ã«å¯¾ã™ã‚‹ç”»åƒãƒ‘ã‚¹ç¾¤ã‚’ã¾ã¨ã‚ã‚‹
      const imagePathsSummary = {};
      for (const imageId of allImageIds) {
        const paths = imagePaths[imageId] || [];
        const basePath = imageBasePaths[imageId] || 'Kitchen';
        const fullPaths = paths.map(path => `${CONFIG.IMAGE_BASE_PATHS[basePath]}${path}`);
        imagePathsSummary[imageId] = {
          base_path: basePath,
          image_count: paths.length,
          paths: paths,
          full_paths: fullPaths
        };
      }
      
      const dataStr = JSON.stringify(imagePathsSummary, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `image_paths_summary_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadCSV() {
      let csv = '\uFEFF'; // BOM for Excel
      csv += 'å‚åŠ è€…å,' + surveyData.participant.name + '\n';
      csv += 'é–‹å§‹æ™‚åˆ»,' + surveyData.participant.startTime + '\n';
      csv += 'çµ‚äº†æ™‚åˆ»,' + surveyData.participant.endTime + '\n';
      if (CONFIG.ENABLE_GROUPING && surveyData.assignedGroup !== null) {
        const totalGroups = Math.ceil(allImageIds.length / CONFIG.GROUP_SIZE);
        csv += 'å‰²ã‚Šå½“ã¦ã‚°ãƒ«ãƒ¼ãƒ—,ã‚°ãƒ«ãƒ¼ãƒ—' + (surveyData.assignedGroup + 1) + '/' + totalGroups + '\n';
        csv += 'è©•ä¾¡ç”»åƒæ•°,' + imageIds.length + 'æšï¼ˆå…¨' + allImageIds.length + 'æšä¸­ï¼‰\n';
      }
      csv += '\n';
      
      // ã‚µãƒãƒªãƒ¼å½¢å¼
      csv += '=== è©•ä¾¡ã‚µãƒãƒªãƒ¼ ===\n\n';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼
      csv += 'ç”»åƒID,';
      for (const agentKey of AGENT_KEYS) {
        csv += `${agentKey}_åŒæ„åº¦,${agentKey}_ç†Ÿæ…®åº¦,`;
      }
      csv += '\n';
      
      // ãƒ‡ãƒ¼ã‚¿
      for (const result of surveyData.validityResults) {
        csv += result.imageId + ',';
        for (const agentKey of AGENT_KEYS) {
          const assessment = result.assessments[agentKey];
          if (assessment) {
            csv += `${assessment.agreeRating || ''},${assessment.thoughtRating || ''},`;
          } else {
            csv += ',,';
          }
        }
        csv += '\n';
      }
      
      // ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      if (surveyData.taskPlanningResults.length > 0) {
        csv += '\n=== ã‚¿ã‚¹ã‚¯è¨ˆç”»è©•ä¾¡ ===\n\n';
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        csv += 'ç”»åƒID,';
        for (const agentKey of AGENT_KEYS) {
          csv += `${agentKey}_å¦¥å½“æ€§,${agentKey}_å®Ÿè¡Œå¯èƒ½æ€§,`;
        }
        csv += '\n';
        
        // ãƒ‡ãƒ¼ã‚¿
        for (const result of surveyData.taskPlanningResults) {
          csv += result.imageId + ',';
          for (const agentKey of AGENT_KEYS) {
            const assessment = result.assessments && result.assessments[agentKey];
            if (assessment) {
              csv += `${assessment.validityRating || ''},${assessment.feasibilityRating || ''},`;
            } else {
              csv += ',,';
            }
          }
          csv += '\n';
        }
      }

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `risk_evaluation_${surveyData.participant.name}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================
    
    function getBadgeClass(judge) {
      if (judge.includes('ç·Šæ€¥é‡å¤§')) return 'critical';
      if (judge.includes('æ½œåœ¨é‡å¤§')) return 'major';
      if (judge.includes('æ½œåœ¨è»½å¾®')) return 'minor';
      if (judge.includes('å¿ƒé…ãªã—') || judge.includes('ãƒªã‚¹ã‚¯ãªã—')) return 'none';
      return 'minor';
    }

    // ãƒªã‚¹ã‚¯ãƒ©ãƒ™ãƒ«ã‚’åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªã«å¤‰æ›
    function getRiskLabel(judge) {
      if (judge.includes('ç·Šæ€¥é‡å¤§')) {
        return 'é‡å¤§ãªãƒªã‚¹ã‚¯ãŒã™ãã«èµ·ã“ã‚‹';
      }
      if (judge.includes('æ½œåœ¨é‡å¤§')) {
        return 'æ¡ä»¶ãŒæƒã†ã¨å¤§ããªãƒªã‚¹ã‚¯';
      }
      if (judge.includes('æ½œåœ¨è»½å¾®')) {
        return 'å°ã•ã‚ã®ãƒªã‚¹ã‚¯';
      }
      if (judge.includes('å¿ƒé…ãªã—') || judge.includes('ãƒªã‚¹ã‚¯ãªã—')) {
        return 'ã»ã¼å¿ƒé…ãªã—';
      }
      // ãã®ä»–ã®ãƒ©ãƒ™ãƒ«ã¯å…ƒã®æ–‡å­—åˆ—ã‚’ãã®ã¾ã¾è¿”ã™
      return judge;
    }

    // ãƒ˜ãƒ«ãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    function toggleHelp(helpId) {
      const helpContent = document.getElementById(helpId);
      if (helpContent) {
        helpContent.classList.toggle('show');
      }
    }

    // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
    function clearError(input) {
      const group = input.closest('.rating-group');
      if (group) {
        group.classList.remove('error');
      }
      hideUnansweredAlert();
    }

    // æœªå›ç­”ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showUnansweredAlert(count) {
      let alert = document.getElementById('unanswered-alert');
      if (!alert) {
        alert = document.createElement('div');
        alert.id = 'unanswered-alert';
        alert.className = 'unanswered-alert';
        document.body.appendChild(alert);
      }
      alert.textContent = `âš ï¸ ${count}ä»¶ã®æœªå›ç­”ãŒã‚ã‚Šã¾ã™`;
      alert.classList.add('show');

      // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆãˆã‚‹
      setTimeout(() => {
        hideUnansweredAlert();
      }, 5000);
    }

    // æœªå›ç­”ã‚¢ãƒ©ãƒ¼ãƒˆéè¡¨ç¤º
    function hideUnansweredAlert() {
      const alert = document.getElementById('unanswered-alert');
      if (alert) {
        alert.classList.remove('show');
      }
    }

    // ãŠã¿ãã˜ã‚’å¼•ã
    function drawOmikuji() {
      const resultEl = document.getElementById('omikuji-result');
      const noteEl = document.getElementById('omikuji-note');
      if (!resultEl) return;

      const idx = Math.floor(Math.random() * OMIKUJI_RESULTS.length);
      const res = OMIKUJI_RESULTS[idx];
      resultEl.textContent = `ã€${res.title}ã€‘${res.message}`;
      if (noteEl) {
        noteEl.style.display = 'block';
      }
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
